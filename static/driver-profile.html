<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Профиль водителя | Жүргізуші профилі</title>
  <style>
    :root {
      /* Light theme */
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --card-bg: rgba(255, 255, 255, 0.95);
      --card-border: rgba(0, 0, 0, 0.08);
      --text-primary: #1a202c;
      --text-secondary: #4a5568;
      --text-muted: #718096;
      --accent-primary: #667eea;
      --accent-secondary: #10b981;
      --accent-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      --input-bg: #f7fafc;
      --input-border: #e2e8f0;
      --input-focus: #667eea;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
      --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.1);
      --nav-bg: rgba(255, 255, 255, 0.95);
      --nav-hover: rgba(102, 126, 234, 0.1);
      --glassmorphism: rgba(255, 255, 255, 0.25);
      --backdrop-blur: blur(20px);
      --tg-viewport-height: 100vh;
    }

    [data-theme="dark"] {
      /* Dark theme */
      --bg-primary: #0f0f23;
      --bg-secondary: #1a1a2e;
      --bg-gradient: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%);
      --card-bg: rgba(26, 26, 46, 0.95);
      --card-border: rgba(255, 255, 255, 0.1);
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --accent-primary: #818cf8;
      --accent-secondary: #34d399;
      --accent-gradient: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
      --success-gradient: linear-gradient(135deg, #34d399 0%, #10b981 100%);
      --warning-gradient: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      --danger-gradient: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
      --input-bg: #1e1e3f;
      --input-border: #374151;
      --input-focus: #818cf8;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.5);
      --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.3);
      --nav-bg: rgba(26, 26, 46, 0.95);
      --nav-hover: rgba(129, 140, 248, 0.1);
      --glassmorphism: rgba(255, 255, 255, 0.1);
      --backdrop-blur: blur(20px);
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      position: relative;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      height: var(--tg-viewport-height);
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-gradient);
      z-index: -1;
      animation: gradientShift 15s ease-in-out infinite;
    }

    @keyframes gradientShift {
      0%, 100% { opacity: 0.05; }
      50% { opacity: 0.15; }
    }

    .main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--glassmorphism);
      backdrop-filter: var(--backdrop-blur);
      -webkit-backdrop-filter: var(--backdrop-blur);
      border-bottom: 1px solid var(--card-border);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0;
    }

    .lang-switch {
      display: flex;
      gap: 4px;
      background: var(--input-bg);
      border-radius: 12px;
      padding: 4px;
      border: 1px solid var(--card-border);
    }

    .lang-switch button {
      background: transparent;
      color: var(--text-secondary);
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      min-width: 40px;
    }

    .lang-switch button.active {
      background: var(--accent-gradient);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .content-wrapper {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 0 20px 100px; /* Bottom padding for buttons */
    }

    .profile-container {
      max-width: 500px;
      margin: 0 auto;
    }

    .profile-header {
      text-align: center;
      margin: 30px 0;
      position: relative;
    }

    .avatar-container {
      position: relative;
      display: inline-block;
      margin-bottom: 20px;
    }

    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--glassmorphism);
      box-shadow: var(--shadow-lg);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .profile-avatar:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-xl);
    }

    .avatar-placeholder {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: var(--input-bg);
      border: 4px solid var(--card-border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .avatar-placeholder:hover {
      transform: scale(1.05);
      background: var(--nav-hover);
    }

    .profile-name {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .profile-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--success-gradient);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 600;
      box-shadow: var(--shadow-md);
    }

    .info-section {
      background: var(--card-bg);
      backdrop-filter: var(--backdrop-blur);
      -webkit-backdrop-filter: var(--backdrop-blur);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-md);
      transition: all 0.3s ease;
    }

    .info-section:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--accent-primary);
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--card-border);
    }

    .info-grid {
      display: grid;
      gap: 16px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
    }

    .info-label {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .info-value {
      color: var(--text-primary);
      font-weight: 500;
      text-align: right;
      flex: 1;
      margin-left: 16px;
    }

    .photo-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    .photo-item {
      text-align: center;
    }

    .photo-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    .photo-preview {
      width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: 16px;
      box-shadow: var(--shadow-md);
      transition: all 0.3s ease;
      cursor: pointer;
      border: 2px solid var(--card-border);
    }

    .photo-preview:hover {
      transform: scale(1.02);
      box-shadow: var(--shadow-lg);
    }

    .no-photo {
      width: 100%;
      height: 140px;
      background: var(--input-bg);
      border: 2px dashed var(--card-border);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 0.875rem;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .no-photo:hover {
      background: var(--nav-hover);
      border-color: var(--accent-primary);
    }

    .no-photo-icon {
      font-size: 2rem;
      margin-bottom: 8px;
      opacity: 0.5;
    }

    /* Update Form Styles */
    .update-form {
      background: var(--card-bg);
      backdrop-filter: var(--backdrop-blur);
      -webkit-backdrop-filter: var(--backdrop-blur);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-md);
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .form-input {
      width: 100%;
      padding: 16px;
      font-size: 1rem;
      border: 2px solid var(--input-border);
      border-radius: 12px;
      background: var(--input-bg);
      color: var(--text-primary);
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--input-focus);
      background: var(--card-bg);
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
      transform: translateY(-1px);
    }

    .file-input {
      padding: 16px;
      cursor: pointer;
      border: 2px dashed var(--input-border);
      background: var(--input-bg);
      transition: all 0.3s ease;
      border-radius: 12px;
      width: 100%;
      font-size: 16px; /* Prevent zoom on iOS */
    }

    .file-input:hover {
      border-color: var(--input-focus);
      background: var(--card-bg);
    }

    .file-input::file-selector-button {
      background: var(--accent-gradient);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      margin-right: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .radio-group {
      display: flex;
      gap: 16px;
      margin-top: 8px;
    }

    .radio-option {
      flex: 1;
      position: relative;
    }

    .radio-input {
      position: absolute;
      opacity: 0;
      cursor: pointer;
    }

    .radio-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      border: 2px solid var(--input-border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: var(--input-bg);
      font-weight: 500;
    }

    .radio-input:checked + .radio-label {
      border-color: var(--accent-primary);
      background: var(--nav-hover);
      color: var(--accent-primary);
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      animation: fadeIn 0.3s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card-bg);
      border-radius: 20px;
      padding: 24px;
      max-width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
      animation: slideIn 0.3s ease;
      border: 1px solid var(--card-border);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--card-border);
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
      transition: color 0.3s;
      padding: 4px;
      border-radius: 8px;
    }

    .close-btn:hover {
      color: var(--text-primary);
      background: var(--nav-hover);
    }

    .modal-image {
      max-width: 100%;
      max-height: 70vh;
      object-fit: contain;
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
    }

    /* Loading States */
    .loading {
      pointer-events: none;
      opacity: 0.6;
      position: relative;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 40px;
      height: 40px;
      margin: -20px 0 0 -20px;
      border: 3px solid var(--input-border);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .page-loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid var(--card-border);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .loading-text {
      font-size: 1.125rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideIn {
      from { transform: translate(-50%, -60%); opacity: 0; }
      to { transform: translate(-50%, -50%); opacity: 1; }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Mobile Optimizations */
    @media (max-width: 480px) {
      .header {
        padding: 12px 16px;
      }

      .header h1 {
        font-size: 1.25rem;
      }

      .content-wrapper {
        padding: 0 16px 100px;
      }

      .profile-avatar, .avatar-placeholder {
        width: 100px;
        height: 100px;
      }

      .profile-name {
        font-size: 1.5rem;
      }

      .info-section {
        padding: 20px;
        border-radius: 16px;
      }

      .photo-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .modal-content {
        padding: 20px;
        border-radius: 16px;
      }

      .radio-group {
        flex-direction: column;
        gap: 12px;
      }

      .form-input, .file-input {
        font-size: 16px; /* Prevent zoom on iOS */
      }
    }

    .hidden {
      display: none !important;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <!-- Loading Screen -->
  <div id="pageLoading" class="page-loading">
    <div class="loading-spinner"></div>
    <div class="loading-text" data-ru="Загрузка профиля..." data-kz="Профільді жүктеу...">Загрузка профиля...</div>
  </div>

  <div id="mainContent" class="main-container hidden">
    <!-- Header -->
    <header class="header">
      <h1 data-ru="Профиль водителя" data-kz="Жүргізуші профилі">Профиль водителя</h1>
      <div class="lang-switch">
        <button onclick="setLang('ru')" id="lang-ru" class="active">RU</button>
        <button onclick="setLang('kz')" id="lang-kz">KZ</button>
      </div>
    </header>

    <div class="content-wrapper">
      <div class="profile-container">
        <!-- Profile View -->
        <div id="profileView">
          <!-- Profile Header -->
          <div class="profile-header">
            <div class="avatar-container">
              <div id="profileAvatarContainer">
                <div class="avatar-placeholder" onclick="showPhoto('profile')">
                  <span>👤</span>
                </div>
              </div>
            </div>
            <div id="profileName" class="profile-name">Загрузка...</div>
            <div class="profile-status">
              <span>✅</span>
              <span data-ru="Активный водитель" data-kz="Белсенді жүргізуші">Активный водитель</span>
            </div>
          </div>

          <!-- Personal Information -->
          <div class="info-section">
            <div class="section-title">
              <span>👤</span>
              <span data-ru="Личная информация" data-kz="Жеке ақпарат">Личная информация</span>
            </div>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label" data-ru="ФИО" data-kz="Аты-жөні">ФИО</span>
                <span id="infoFullName" class="info-value">-</span>
              </div>
              <div class="info-item">
                <span class="info-label" data-ru="Контакт" data-kz="Байланыс">Контакт</span>
                <span id="infoContact" class="info-value">-</span>
              </div>
              <div class="info-item">
                <span class="info-label" data-ru="Пол" data-kz="Жынысы">Пол</span>
                <span id="infoGender" class="info-value">-</span>
              </div>
            </div>
          </div>

          <!-- Location -->
          <div class="info-section">
            <div class="section-title">
              <span>📍</span>
              <span data-ru="Локация" data-kz="Орналасу">Локация</span>
            </div>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label" data-ru="Город отправления" data-kz="Жөнелу қаласы">Город отправления</span>
                <span id="infoStartCity" class="info-value">-</span>
              </div>
            </div>
          </div>

          <!-- Photos -->
          <div class="info-section">
            <div class="section-title">
              <span>📸</span>
              <span data-ru="Фотографии" data-kz="Фотосуреттер">Фотографии</span>
            </div>
            <div class="photo-grid">
              <div class="photo-item">
                <div class="photo-label" data-ru="Фото транспорта" data-kz="Көлік фотосы">Фото транспорта</div>
                <div id="truckPhotoContainer">
                  <div class="no-photo" onclick="showUpdateForm()">
                    <div class="no-photo-icon">🚛</div>
                    <span data-ru="Нет фото" data-kz="Фото жоқ">Нет фото</span>
                  </div>
                </div>
              </div>
              <div class="photo-item">
                <div class="photo-label" data-ru="Документы" data-kz="Құжаттар">Документы</div>
                <div id="documentsContainer">
                  <div class="no-photo">
                    <div class="no-photo-icon">📋</div>
                    <span data-ru="Нет документов" data-kz="Құжаттар жоқ">Нет документов</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Update Form -->
        <div id="updateView" class="hidden">
          <div class="update-form">
            <div class="section-title">
              <span>✏️</span>
              <span data-ru="Редактировать профиль" data-kz="Профільді өңдеу">Редактировать профиль</span>
            </div>

            <form id="updateForm" enctype="multipart/form-data">
              <div class="form-group">
                <div class="form-label">
                  <span>📸</span>
                  <span data-ru="Фото профиля" data-kz="Профиль фотосы">Фото профиля</span>
                </div>
                <input type="file" id="update_profile_photo" name="profile_photo" class="file-input" accept="image/*">
              </div>

              <div class="form-group">
                <div class="form-label">
                  <span>👤</span>
                  <span data-ru="ФИО" data-kz="Аты-жөні">ФИО</span>
                </div>
                <input type="text" id="update_full_name" name="full_name" class="form-input" required>
              </div>

              <div class="form-group">
                <div class="form-label">
                  <span>📱</span>
                  <span data-ru="Контактный номер" data-kz="Байланыс нөмірі">Контактный номер</span>
                </div>
                <input type="tel" id="update_contact" name="contact" class="form-input" placeholder="+7 (___) ___-__-__" required>
              </div>

              <div class="form-group">
                <div class="form-label">
                  <span>⚧️</span>
                  <span data-ru="Пол" data-kz="Жынысы">Пол</span>
                </div>
                <div class="radio-group">
                  <div class="radio-option">
                    <input type="radio" name="gender" value="male" id="gender_male" class="radio-input" required>
                    <label for="gender_male" class="radio-label">
                      <span>👨</span>
                      <span data-ru="Мужской" data-kz="Ер">Мужской</span>
                    </label>
                  </div>
                  <div class="radio-option">
                    <input type="radio" name="gender" value="female" id="gender_female" class="radio-input" required>
                    <label for="gender_female" class="radio-label">
                      <span>👩</span>
                      <span data-ru="Женский" data-kz="Әйел">Женский</span>
                    </label>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <div class="form-label">
                  <span>🚛</span>
                  <span data-ru="Фото транспорта" data-kz="Көлік фотосы">Фото транспорта</span>
                </div>
                <input type="file" id="update_truck_photo" name="truck_photo" class="file-input" accept="image/*">
              </div>

              <div class="form-group">
                <div class="form-label">
                  <span>📋</span>
                  <span data-ru="Водительское удостоверение" data-kz="Жүргізуші куәлігі">Водительское удостоверение</span>
                </div>
                <input type="file" id="update_driver_license" name="driver_license" class="file-input" accept=".pdf,.jpg,.png,.jpeg">
              </div>

              <div class="form-group">
                <div class="form-label">
                  <span>📍</span>
                  <span data-ru="Город отправления" data-kz="Жөнелу қаласы">Город отправления</span>
                </div>
                <input type="text" id="update_start_city" name="start_city" class="form-input" 
                       placeholder="Введите адрес" required>
              </div>

              <input type="hidden" name="telegram_id" id="update_telegram_id">
              <input type="hidden" name="start_lat" id="update_start_lat">
              <input type="hidden" name="start_lon" id="update_start_lon">
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Photo Modal -->
  <div id="photoModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle" class="modal-title" data-ru="Фотография" data-kz="Фотосурет">Фотография</h2>
        <button class="close-btn" onclick="closePhotoModal()">&times;</button>
      </div>
      <img id="modalImage" src="" alt="Photo" class="modal-image">
    </div>
  </div>

  <script>
    // Set Telegram viewport height
    function updateViewportHeight() {
      const vh = Telegram.WebApp.viewportHeight || window.innerHeight;
      document.documentElement.style.setProperty('--tg-viewport-height', `${vh}px`);
    }

    // Telegram WebApp initialization
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
    updateViewportHeight();
    
    // Update viewport on resize
    Telegram.WebApp.onEvent('viewportChanged', updateViewportHeight);
    window.addEventListener('resize', updateViewportHeight);

    // Apply Telegram theme
    if (Telegram.WebApp.colorScheme) {
      document.documentElement.setAttribute('data-theme', Telegram.WebApp.colorScheme);
    }

    Telegram.WebApp.onEvent('themeChanged', function() {
      if (Telegram.WebApp.colorScheme) {
        document.documentElement.setAttribute('data-theme', Telegram.WebApp.colorScheme);
      }
    });

    // Auto theme detection as fallback
    function detectTheme() {
      const hour = new Date().getHours();
      return (hour >= 6 && hour < 18) ? 'light' : 'dark';
    }

    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
    }

    // Apply fallback theme if no Telegram theme
    if (!Telegram.WebApp.colorScheme) {
      let currentTheme = detectTheme();
      applyTheme(currentTheme);

      setInterval(() => {
        const newTheme = detectTheme();
        if (newTheme !== currentTheme) {
          currentTheme = newTheme;
          applyTheme(currentTheme);
        }
      }, 60000);
    }

    // Language management with proper button updates
    let currentLang = 'ru';
    const translations = {
      ru: {
        loadingProfile: 'Загрузка профиля...',
        activeDriver: 'Активный водитель',
        personalInfo: 'Личная информация',
        fullName: 'ФИО',
        contact: 'Контакт',
        gender: 'Пол',
        male: 'Мужской',
        female: 'Женский',
        location: 'Локация',
        startCity: 'Город отправления',
        photos: 'Фотографии',
        truckPhoto: 'Фото транспорта',
        documents: 'Документы',
        noPhoto: 'Нет фото',
        noDocuments: 'Нет документов',
        createRequest: 'Создать заявку',
        editProfile: 'Редактировать профиль',
        photo: 'Фотография',
        profileUpdated: 'Профиль обновлен!',
        error: 'Ошибка',
        saving: 'Сохранение...',
        cancel: 'Отмена',
        save: 'Сохранить',
        fillAllFields: 'Заполните все поля',
        telegramIdNotFound: 'Не удалось получить ID пользователя',
        redirectingToRegistration: 'Перенаправление на регистрацию...',
        back: 'Назад'
      },
      kz: {
        loadingProfile: 'Профільді жүктеу...',
        activeDriver: 'Белсенді жүргізуші',
        personalInfo: 'Жеке ақпарат',
        fullName: 'Аты-жөні',
        contact: 'Байланыс',
        gender: 'Жынысы',
        male: 'Ер',
        female: 'Әйел',
        location: 'Орналасу',
        startCity: 'Жөнелу қаласы',
        photos: 'Фотосуреттер',
        truckPhoto: 'Көлік фотосы',
        documents: 'Құжаттар',
        noPhoto: 'Фото жоқ',
        noDocuments: 'Құжаттар жоқ',
        createRequest: 'Өтінім жасау',
        editProfile: 'Профільді өңдеу',
        photo: 'Фотосурет',
        profileUpdated: 'Профиль жаңартылды!',
        error: 'Қате',
        saving: 'Сақтау...',
        cancel: 'Болдырмау',
        save: 'Сақтау',
        fillAllFields: 'Барлық өрістерді толтырыңыз',
        telegramIdNotFound: 'Пайдаланушы ID алу мүмкін болмады',
        redirectingToRegistration: 'Тіркелуге бағыттау...',
        back: 'Артқа'
      }
    };

    function setLang(lang) {
      currentLang = lang;
      document.querySelectorAll('.lang-switch button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById('lang-' + lang).classList.add('active');
      
      // Update all elements with data attributes
      document.querySelectorAll('[data-ru]').forEach(el => {
        el.textContent = el.getAttribute('data-' + lang) || el.textContent;
      });
      
      updateNoPhotoTexts();
      updateMainButton(); // Update button text when language changes
    }

    function updateNoPhotoTexts() {
      const noPhotoElements = document.querySelectorAll('.no-photo span:not(.no-photo-icon)');
      noPhotoElements.forEach(el => {
        if (el.textContent.includes('Нет фото') || el.textContent.includes('Фото жоқ')) {
          el.textContent = translations[currentLang].noPhoto;
        }
        if (el.textContent.includes('Нет документов') || el.textContent.includes('Құжаттар жоқ')) {
          el.textContent = translations[currentLang].noDocuments;
        }
      });
    }

    // Get Telegram ID
    let telegramId = null;
    
    // Try to get from Telegram WebApp
    if (Telegram.WebApp.initDataUnsafe?.user?.id) {
      telegramId = Telegram.WebApp.initDataUnsafe.user.id;
    }
    
    // Fallback: check URL parameters
    if (!telegramId) {
      const urlParams = new URLSearchParams(window.location.search);
      const testId = urlParams.get('test_id');
      if (testId) {
        telegramId = parseInt(testId);
      }
    }
    
    // Development fallback
    if (!telegramId && (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')) {
      telegramId = 800703982; // Replace with your test ID
    }

    // Global variables
    let driverData = null;
    let isInUpdateMode = false;

    // Main functions
    async function loadDriverProfile() {
      if (!telegramId) {
        showError(translations[currentLang].telegramIdNotFound);
        return;
      }

      try {
        const response = await fetch('/api/driver/profile', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            telegram_id: telegramId.toString()
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success && data.driver) {
          driverData = data.driver;
          displayDriverProfile(data.driver);
          hideLoading();
          setupMainButton();
        } else {
          throw new Error(data.message || 'Driver not found');
        }
      } catch (error) {
        console.error('Error loading driver profile:', error);
        if (error.message.includes('404') || error.message.includes('not found')) {
          showError(translations[currentLang].redirectingToRegistration);
          setTimeout(() => {
            window.location.href = '/driver-register';
          }, 2000);
        } else {
          showError(translations[currentLang].error + ': ' + error.message);
        }
      }
    }

    function displayDriverProfile(driver) {
      // Profile avatar
      const avatarContainer = document.getElementById('profileAvatarContainer');
      if (driver.profile_photo_path) {
        avatarContainer.innerHTML = `
          <img src="/files/${driver.profile_photo_path}" 
               alt="Profile" 
               class="profile-avatar" 
               onclick="showPhoto('profile')">
        `;
      } else {
        avatarContainer.innerHTML = `
          <div class="avatar-placeholder" onclick="showUpdateForm()">
            <span>👤</span>
          </div>
        `;
      }

      // Profile name
      document.getElementById('profileName').textContent = driver.full_name || 'Не указано';

      // Personal information
      document.getElementById('infoFullName').textContent = driver.full_name || '-';
      document.getElementById('infoContact').textContent = driver.contact || '-';
      document.getElementById('infoGender').textContent = 
        driver.gender === 'male' ? translations[currentLang].male : 
        driver.gender === 'female' ? translations[currentLang].female : '-';

      // Location
      document.getElementById('infoStartCity').textContent = driver.start_city || '-';

      // Photos
      const truckContainer = document.getElementById('truckPhotoContainer');
      if (driver.truck_photo_path) {
        truckContainer.innerHTML = `
          <img src="/files/${driver.truck_photo_path}" 
               alt="Truck" 
               class="photo-preview" 
               onclick="showPhoto('truck')">
        `;
      } else {
        truckContainer.innerHTML = `
          <div class="no-photo" onclick="showUpdateForm()">
            <div class="no-photo-icon">🚛</div>
            <span>${translations[currentLang].noPhoto}</span>
          </div>
        `;
      }

      const documentsContainer = document.getElementById('documentsContainer');
      if (driver.driver_license_path) {
        documentsContainer.innerHTML = `
          <img src="/files/${driver.driver_license_path}" 
               alt="License" 
               class="photo-preview" 
               onclick="showPhoto('documents')">
        `;
      } else {
        documentsContainer.innerHTML = `
          <div class="no-photo">
            <div class="no-photo-icon">📋</div>
            <span>${translations[currentLang].noDocuments}</span>
          </div>
        `;
      }

      // Fill update form
      fillUpdateForm(driver);
    }

    function fillUpdateForm(driver) {
      document.getElementById('update_telegram_id').value = telegramId;
      document.getElementById('update_full_name').value = driver.full_name || '';
      document.getElementById('update_contact').value = driver.contact || '';
      document.getElementById('update_start_city').value = driver.start_city || '';
      document.getElementById('update_start_lat').value = driver.start_lat || '';
      document.getElementById('update_start_lon').value = driver.start_lon || '';

      // Set gender radio
      if (driver.gender) {
        const genderRadio = document.getElementById(`gender_${driver.gender}`);
        if (genderRadio) {
          genderRadio.checked = true;
        }
      }
    }

    function showUpdateForm() {
      isInUpdateMode = true;
      document.getElementById('profileView').classList.add('hidden');
      document.getElementById('updateView').classList.remove('hidden');
      updateMainButton();
      
      // Give haptic feedback
      if (Telegram.WebApp.HapticFeedback) {
        Telegram.WebApp.HapticFeedback.impactOccurred('medium');
      }
    }

    function cancelUpdate() {
      isInUpdateMode = false;
      document.getElementById('updateView').classList.add('hidden');
      document.getElementById('profileView').classList.remove('hidden');
      updateMainButton();
      
      // Give haptic feedback
      if (Telegram.WebApp.HapticFeedback) {
        Telegram.WebApp.HapticFeedback.impactOccurred('light');
      }
    }

    async function saveProfile() {
      const form = document.getElementById('updateForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        // Give error haptic feedback
        if (Telegram.WebApp.HapticFeedback) {
          Telegram.WebApp.HapticFeedback.notificationOccurred('error');
        }
        return;
      }

      const updateView = document.getElementById('updateView');
      updateView.classList.add('loading');

      // Show progress in main button
      Telegram.WebApp.MainButton.showProgress();

      const formData = new FormData(form);

      try {
        const response = await fetch('/api/driver/update', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (result.success && result.driver) {
          driverData = result.driver;
          displayDriverProfile(result.driver);
          cancelUpdate();
          showSuccess(translations[currentLang].profileUpdated);
          
          // Give success haptic feedback
          if (Telegram.WebApp.HapticFeedback) {
            Telegram.WebApp.HapticFeedback.notificationOccurred('success');
          }
        } else {
          throw new Error(result.message || 'Update failed');
        }
      } catch (error) {
        console.error('Error updating profile:', error);
        showError(translations[currentLang].error + ': ' + error.message);
        
        // Give error haptic feedback
        if (Telegram.WebApp.HapticFeedback) {
          Telegram.WebApp.HapticFeedback.notificationOccurred('error');
        }
      } finally {
        updateView.classList.remove('loading');
        Telegram.WebApp.MainButton.hideProgress();
      }
    }

    function showPhoto(type) {
      if (!driverData) return;

      let imageSrc = '';
      let title = '';

      switch (type) {
        case 'profile':
          if (driverData.profile_photo_path) {
            imageSrc = `/files/${driverData.profile_photo_path}`;
            title = 'Фото профиля';
          }
          break;
        case 'truck':
          if (driverData.truck_photo_path) {
            imageSrc = `/files/${driverData.truck_photo_path}`;
            title = translations[currentLang].truckPhoto;
          }
          break;
        case 'documents':
          if (driverData.driver_license_path) {
            imageSrc = `/files/${driverData.driver_license_path}`;
            title = translations[currentLang].documents;
          }
          break;
      }

      if (imageSrc) {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalImage').src = imageSrc;
        document.getElementById('photoModal').style.display = 'block';
      }
    }

    function closePhotoModal() {
      document.getElementById('photoModal').style.display = 'none';
    }

    function createRequest() {
      window.location.href = '/driver-request';
    }

    // Enhanced Telegram WebApp button management with dual buttons
    function setupMainButton() {
      updateMainButton();
      
      // Handle main button clicks
      Telegram.WebApp.onEvent('mainButtonClicked', () => {
        if (isInUpdateMode) {
          saveProfile();
        } else {
          createRequest();
        }
      });

      // Handle back button
      Telegram.WebApp.onEvent('backButtonClicked', () => {
        if (isInUpdateMode) {
          cancelUpdate();
        } else {
          Telegram.WebApp.close();
        }
      });

      // Setup secondary button (edit profile) for profile view
      setupSecondaryButton();
    }

    function setupSecondaryButton() {
      // Create secondary button for profile editing when not in update mode
      if (!isInUpdateMode) {
        // Check if SecondaryButton exists in this Telegram version
        if (Telegram.WebApp.SecondaryButton) {
          Telegram.WebApp.SecondaryButton.setText('✏️ ' + translations[currentLang].editProfile);
          Telegram.WebApp.SecondaryButton.show();
          Telegram.WebApp.SecondaryButton.enable();
          Telegram.WebApp.SecondaryButton.color = '#f59e0b'; // Orange color
          
          // Handle secondary button clicks
          Telegram.WebApp.onEvent('secondaryButtonClicked', () => {
            showUpdateForm();
          });
        } else {
          // Fallback: use HapticFeedback to indicate edit action is available
          // Show a hint to user that they can edit by tapping on photos or profile
          console.log('SecondaryButton not available in this Telegram version');
        }
      }
    }

    function updateMainButton() {
      if (isInUpdateMode) {
        // Update mode: Show back button and save button
        Telegram.WebApp.BackButton.show();
        Telegram.WebApp.MainButton.setText('💾 ' + translations[currentLang].save);
        Telegram.WebApp.MainButton.show();
        Telegram.WebApp.MainButton.enable();
        Telegram.WebApp.MainButton.color = '#10b981'; // Green color for save
        
        // Hide secondary button in update mode
        if (Telegram.WebApp.SecondaryButton) {
          Telegram.WebApp.SecondaryButton.hide();
        }
      } else {
        // Profile view mode: Show create request button and edit button
        Telegram.WebApp.BackButton.hide();
        Telegram.WebApp.MainButton.setText('🚚 ' + translations[currentLang].createRequest);
        Telegram.WebApp.MainButton.show();
        Telegram.WebApp.MainButton.enable();
        Telegram.WebApp.MainButton.color = '#3b82f6'; // Blue color for create request
        
        // Show secondary button for editing
        if (Telegram.WebApp.SecondaryButton) {
          Telegram.WebApp.SecondaryButton.setText('✏️ ' + translations[currentLang].editProfile);
          Telegram.WebApp.SecondaryButton.show();
          Telegram.WebApp.SecondaryButton.enable();
          Telegram.WebApp.SecondaryButton.color = '#f59e0b'; // Orange color
        }
      }
    }

    function hideLoading() {
      document.getElementById('pageLoading').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
    }

    function showError(message) {
      hideLoading();
      Telegram.WebApp.showAlert(message);
    }

    function showSuccess(message) {
      Telegram.WebApp.showAlert(message);
    }

    // Phone formatting
    document.getElementById('update_contact').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      let formattedValue = '';
      
      if (value.length > 0) {
        formattedValue = '+7';
        if (value.length > 1) {
          formattedValue += ' (' + value.substring(1, 4);
          if (value.length > 4) {
            formattedValue += ') ' + value.substring(4, 7);
            if (value.length > 7) {
              formattedValue += '-' + value.substring(7, 9);
              if (value.length > 9) {
                formattedValue += '-' + value.substring(9, 11);
              }
            }
          } else if (value.length > 1) {
            formattedValue += ')';
          }
        }
      }
      
      e.target.value = formattedValue;
    });

    // Close modal on click outside
    document.getElementById('photoModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closePhotoModal();
      }
    });

    // File input visual feedback
    document.querySelectorAll('.file-input').forEach(input => {
      input.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
          e.target.style.borderColor = 'var(--input-focus)';
          e.target.style.background = 'var(--card-bg)';
          
          // Visual feedback
          const parent = e.target.parentElement;
          parent.style.transform = 'scale(0.98)';
          setTimeout(() => {
            parent.style.transform = 'scale(1)';
          }, 200);
        }
      });
    });

    // Make functions global
    window.setLang = setLang;
    window.showUpdateForm = showUpdateForm;
    window.cancelUpdate = cancelUpdate;
    window.saveProfile = saveProfile;
    window.showPhoto = showPhoto;
    window.closePhotoModal = closePhotoModal;
    window.createRequest = createRequest;

    // Initialize app
    setTimeout(() => {
      loadDriverProfile();
    }, 500);
  </script>
</body>
</html>