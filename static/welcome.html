<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Добро пожаловать в ZholDa | ZholDa-ға қош келдіңіз</title>
  <style>
    :root {
      /* Light theme */
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      --card-bg: rgba(255, 255, 255, 0.95);
      --card-border: rgba(0, 0, 0, 0.06);
      --text-primary: #1a202c;
      --text-secondary: #4a5568;
      --text-muted: #718096;
      --accent-primary: #667eea;
      --accent-secondary: #10b981;
      --driver-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --client-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.15);
      --shadow-xl: 0 20px 60px rgba(0, 0, 0, 0.2);
      --glassmorphism: rgba(255, 255, 255, 0.25);
      --backdrop-blur: blur(20px);
      --tg-viewport-height: 100vh;
    }

    [data-theme="dark"] {
      /* Dark theme */
      --bg-primary: #0f0f23;
      --bg-secondary: #1a1a2e;
      --bg-gradient: linear-gradient(135deg, #16213e 0%, #1a1a2e 50%, #0f0f23 100%);
      --card-bg: rgba(26, 26, 46, 0.95);
      --card-border: rgba(255, 255, 255, 0.08);
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --accent-primary: #818cf8;
      --accent-secondary: #34d399;
      --driver-gradient: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
      --client-gradient: linear-gradient(135deg, #34d399 0%, #10b981 100%);
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.5);
      --shadow-xl: 0 20px 60px rgba(0, 0, 0, 0.6);
      --glassmorphism: rgba(255, 255, 255, 0.1);
      --backdrop-blur: blur(20px);
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Inter', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      position: relative;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      height: var(--tg-viewport-height);
    }

    /* Animated background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-gradient);
      z-index: -2;
      animation: gradientShift 20s ease-in-out infinite;
    }

    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 30%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(240, 147, 251, 0.1) 0%, transparent 50%);
      z-index: -1;
      animation: floatingOrbs 30s ease-in-out infinite;
    }

    @keyframes gradientShift {
      0%, 100% { transform: rotate(0deg) scale(1); }
      25% { transform: rotate(90deg) scale(1.1); }
      50% { transform: rotate(180deg) scale(1); }
      75% { transform: rotate(270deg) scale(1.1); }
    }

    @keyframes floatingOrbs {
      0%, 100% { transform: translate(0, 0); }
      25% { transform: translate(20px, -20px); }
      50% { transform: translate(-20px, 20px); }
      75% { transform: translate(20px, 20px); }
    }

    .main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
      position: relative;
    }

    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: var(--glassmorphism);
      backdrop-filter: var(--backdrop-blur);
      -webkit-backdrop-filter: var(--backdrop-blur);
      border-bottom: 1px solid var(--card-border);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.5rem;
      font-weight: 900;
      background: var(--driver-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.02em;
    }

    .logo-icon {
      font-size: 2rem;
      filter: drop-shadow(0 4px 12px rgba(102, 126, 234, 0.3));
      animation: bounce 3s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    .lang-switch {
      display: flex;
      gap: 4px;
      background: var(--glassmorphism);
      border-radius: 16px;
      padding: 6px;
      border: 1px solid var(--card-border);
      backdrop-filter: var(--backdrop-blur);
      -webkit-backdrop-filter: var(--backdrop-blur);
    }

    .lang-switch button {
      background: transparent;
      color: var(--text-secondary);
      border: none;
      border-radius: 12px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.875rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-width: 50px;
    }

    .lang-switch button.active {
      background: var(--driver-gradient);
      color: white;
      box-shadow: var(--shadow-md);
      transform: scale(1.05);
    }

    .content-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 100px 20px 40px;
      position: relative;
    }

    .welcome-container {
      max-width: 480px;
      width: 100%;
      text-align: center;
      animation: slideInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(40px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .welcome-header {
      margin-bottom: 60px;
    }

    .welcome-title {
      font-size: 2.5rem;
      font-weight: 900;
      margin-bottom: 16px;
      background: var(--driver-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1.2;
      letter-spacing: -0.03em;
      animation: titleGlow 3s ease-in-out infinite;
    }

    @keyframes titleGlow {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.2); }
    }

    .welcome-subtitle {
      font-size: 1.25rem;
      color: var(--text-secondary);
      font-weight: 500;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    .welcome-description {
      font-size: 1rem;
      color: var(--text-muted);
      line-height: 1.6;
      font-weight: 400;
    }

    .buttons-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-top: 40px;
    }

    .choice-button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      padding: 24px 32px;
      border: none;
      border-radius: 20px;
      font-size: 1.125rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      backdrop-filter: var(--backdrop-blur);
      -webkit-backdrop-filter: var(--backdrop-blur);
      border: 1px solid var(--card-border);
      text-decoration: none;
      box-shadow: var(--shadow-md);
      letter-spacing: 0.01em;
    }

    .choice-button:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: var(--shadow-xl);
    }

    .choice-button:active {
      transform: translateY(-2px) scale(1.01);
    }

    .driver-button {
      background: var(--driver-gradient);
      color: white;
    }

    .client-button {
      background: var(--client-gradient);
      color: white;
    }

    .button-icon {
      font-size: 2rem;
      filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.2));
      animation: iconFloat 4s ease-in-out infinite;
    }

    .driver-button .button-icon {
      animation-delay: 0s;
    }

    .client-button .button-icon {
      animation-delay: 2s;
    }

    @keyframes iconFloat {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      25% { transform: translateY(-2px) rotate(1deg); }
      50% { transform: translateY(0) rotate(0deg); }
      75% { transform: translateY(-2px) rotate(-1deg); }
    }

    .button-content {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      text-align: left;
    }

    .button-title {
      font-size: 1.25rem;
      font-weight: 800;
      margin-bottom: 4px;
      letter-spacing: -0.01em;
    }

    .button-subtitle {
      font-size: 0.875rem;
      opacity: 0.9;
      font-weight: 500;
    }

    /* Floating particles */
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }

    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: var(--accent-primary);
      border-radius: 50%;
      opacity: 0.6;
      animation: float 20s infinite linear;
    }

    .particle:nth-child(odd) {
      background: var(--accent-secondary);
      animation-duration: 25s;
    }

    .particle:nth-child(3n) {
      width: 6px;
      height: 6px;
      animation-duration: 30s;
    }

    @keyframes float {
      0% {
        transform: translateY(100vh) rotate(0deg);
        opacity: 0;
      }
      10% {
        opacity: 0.6;
      }
      90% {
        opacity: 0.6;
      }
      100% {
        transform: translateY(-100px) rotate(360deg);
        opacity: 0;
      }
    }

    /* Loading state */
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .loading.hidden {
      opacity: 0;
      visibility: hidden;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid var(--card-border);
      border-top: 4px solid var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 24px;
    }

    .loading-text {
      font-size: 1.125rem;
      color: var(--text-secondary);
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Mobile optimizations */
    @media (max-width: 480px) {
      .header {
        padding: 12px 16px;
      }

      .logo {
        font-size: 1.25rem;
      }

      .logo-icon {
        font-size: 1.75rem;
      }

      .content-wrapper {
        padding: 80px 16px 20px;
      }

      .welcome-title {
        font-size: 2rem;
      }

      .welcome-subtitle {
        font-size: 1.125rem;
      }

      .welcome-description {
        font-size: 0.95rem;
      }

      .choice-button {
        padding: 20px 24px;
        font-size: 1rem;
      }

      .button-icon {
        font-size: 1.75rem;
      }

      .button-title {
        font-size: 1.125rem;
      }

      .button-subtitle {
        font-size: 0.8rem;
      }
    }

    /* Accessibility */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading" class="loading">
    <div class="loading-spinner"></div>
    <div class="loading-text" data-ru="Загрузка..." data-kz="Жүктелуде...">Загрузка...</div>
  </div>

  <!-- Floating Particles -->
  <div class="particles" id="particles"></div>

  <div class="main-container">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <span class="logo-icon">🚚</span>
        <span>ZholDa</span>
      </div>
      <div class="lang-switch">
        <button onclick="setLang('ru')" id="lang-ru" class="active">RU</button>
        <button onclick="setLang('kz')" id="lang-kz">KZ</button>
      </div>
    </header>

    <!-- Content -->
    <div class="content-wrapper">
      <div class="welcome-container">
        <div class="welcome-header">
          <h1 class="welcome-title" data-ru="Добро пожаловать в ZholDa!" data-kz="ZholDa-ға қош келдіңіз!">
            Добро пожаловать в ZholDa!
          </h1>
          <p class="welcome-subtitle" data-ru="Современная платформа логистики" data-kz="Заманауи логистика платформасы">
            Современная платформа логистики
          </p>
          <p class="welcome-description" data-ru="Соединяем водителей и клиентов для быстрой и надежной доставки грузов по всему Казахстану" data-kz="Жүргізушілер мен клиенттерді Қазақстан бойынша жылдам және сенімді жүк тасымалдау үшін біріктіреміз">
            Соединяем водителей и клиентов для быстрой и надежной доставки грузов по всему Казахстану
          </p>
        </div>

        <div class="buttons-container">
          <a href="/driver-register" class="choice-button driver-button" id="driverButton">
            <span class="button-icon">🚛</span>
            <div class="button-content">
              <div class="button-title" data-ru="Стать водителем" data-kz="Жүргізуші болу">Стать водителем</div>
              <div class="button-subtitle" data-ru="Зарабатывайте на доставке грузов" data-kz="Жүк тасымалдаудан табыс табыңыз">Зарабатывайте на доставке грузов</div>
            </div>
          </a>

          <a href="/client" class="choice-button client-button" id="clientButton">
            <span class="button-icon">📦</span>
            <div class="button-content">
              <div class="button-title" data-ru="Заказать доставку" data-kz="Жеткізуге тапсырыс беру">Заказать доставку</div>
              <div class="button-subtitle" data-ru="Отправьте груз быстро и безопасно" data-kz="Жүкті жылдам және қауіпсіз жіберіңіз">Отправьте груз быстро и безопасно</div>
            </div>
          </a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Set Telegram viewport height
    function updateViewportHeight() {
      const vh = Telegram.WebApp?.viewportHeight || window.innerHeight;
      document.documentElement.style.setProperty('--tg-viewport-height', `${vh}px`);
    }

    // Initialize Telegram WebApp
    if (window.Telegram?.WebApp) {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
      updateViewportHeight();
      Telegram.WebApp.onEvent('viewportChanged', updateViewportHeight);

      // Apply Telegram theme
      if (Telegram.WebApp.colorScheme) {
        document.documentElement.setAttribute('data-theme', Telegram.WebApp.colorScheme);
      }

      Telegram.WebApp.onEvent('themeChanged', function() {
        if (Telegram.WebApp.colorScheme) {
          document.documentElement.setAttribute('data-theme', Telegram.WebApp.colorScheme);
        }
      });
    } else {
      updateViewportHeight();
    }

    // Auto theme detection as fallback
    function detectTheme() {
      const hour = new Date().getHours();
      return (hour >= 6 && hour < 20) ? 'light' : 'dark';
    }

    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
    }

    // Apply fallback theme if no Telegram theme
    if (!window.Telegram?.WebApp?.colorScheme) {
      let currentTheme = detectTheme();
      applyTheme(currentTheme);

      setInterval(() => {
        const newTheme = detectTheme();
        if (newTheme !== currentTheme) {
          currentTheme = newTheme;
          applyTheme(currentTheme);
        }
      }, 60000);
    }

    // Language management
    let currentLang = 'ru';

    function setLang(lang) {
      currentLang = lang;
      document.querySelectorAll('.lang-switch button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById('lang-' + lang).classList.add('active');
      
      // Update all elements with data attributes
      document.querySelectorAll('[data-ru]').forEach(el => {
        el.textContent = el.getAttribute('data-' + lang) || el.textContent;
      });
    }

    // Get Telegram ID for user checking
    let telegramId = null;
    
    if (window.Telegram?.WebApp?.initDataUnsafe?.user?.id) {
      telegramId = window.Telegram.WebApp.initDataUnsafe.user.id;
    }
    
    // Fallback for development
    if (!telegramId && (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')) {
      const urlParams = new URLSearchParams(window.location.search);
      const testId = urlParams.get('test_id');
      if (testId) {
        telegramId = parseInt(testId);
      } else {
        telegramId = 800703982; // Development fallback
      }
    }

    // Check user status and redirect accordingly
    async function checkUserStatus() {
      if (!telegramId) {
        hideLoading();
        return;
      }

      try {
        // Check if user is a driver
        const driverResponse = await fetch('/api/driver/profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ telegram_id: telegramId.toString() })
        });

        if (driverResponse.ok) {
          const driverData = await driverResponse.json();
          if (driverData.success && driverData.driver) {
            // User is a registered driver, redirect to driver profile
            window.location.href = '/driver-profile';
            return;
          }
        }

        // Check if user is a client
        const clientResponse = await fetch('/api/client/check', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ telegram_id: telegramId.toString() })
        });

        if (clientResponse.ok) {
          const clientData = await clientResponse.json();
          if (clientData.exists && clientData.offerta_accepted) {
            // User is a registered client, redirect to client page
            window.location.href = '/client';
            return;
          }
        }

        // User is new, show welcome page
        hideLoading();
        
      } catch (error) {
        console.error('Error checking user status:', error);
        // On error, show welcome page
        hideLoading();
      }
    }

    function hideLoading() {
      document.getElementById('loading').classList.add('hidden');
    }

    // Create floating particles
    function createParticles() {
      const particlesContainer = document.getElementById('particles');
      const particleCount = 20;

      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 20 + 's';
        particle.style.animationDuration = (20 + Math.random() * 10) + 's';
        particlesContainer.appendChild(particle);
      }
    }

    // Add haptic feedback for buttons
    function addHapticFeedback() {
      document.querySelectorAll('.choice-button').forEach(button => {
        button.addEventListener('click', () => {
          if (window.Telegram?.WebApp?.HapticFeedback) {
            Telegram.WebApp.HapticFeedback.impactOccurred('medium');
          }
        });
      });
    }

    // Initialize everything
    window.addEventListener('load', () => {
      createParticles();
      addHapticFeedback();
      
      // Check user status after a short delay
      setTimeout(checkUserStatus, 1000);
    });

    // Make functions global
    window.setLang = setLang;
  </script>
</body>
</html>