<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Заказать доставку | Жеткізуге тапсырыс беру</title>
  <style>
    :root {
      /* Light theme */
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --card-bg: rgba(255, 255, 255, 0.98);
      --card-border: rgba(0, 0, 0, 0.06);
      --text-primary: #1a202c;
      --text-secondary: #4a5568;
      --text-muted: #718096;
      --accent-primary: #10b981;
      --accent-secondary: #3b82f6;
      --accent-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --secondary-gradient: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      --input-bg: #f7fafc;
      --input-border: #e2e8f0;
      --input-focus: #10b981;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
      --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.15);
      --nav-bg: rgba(255, 255, 255, 0.9);
      --nav-hover: rgba(16, 185, 129, 0.1);
      --progress-bg: rgba(16, 185, 129, 0.1);
      --progress-fill: #10b981;
      --glow: rgba(16, 185, 129, 0.5);
      --route-color: #10b981;
      --tg-viewport-height: 100vh;
    }

    [data-theme="dark"] {
      /* Dark theme */
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-gradient: linear-gradient(135deg, #059669 0%, #047857 100%);
      --card-bg: rgba(30, 41, 59, 0.98);
      --card-border: rgba(255, 255, 255, 0.06);
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --accent-primary: #34d399;
      --accent-secondary: #60a5fa;
      --accent-gradient: linear-gradient(135deg, #34d399 0%, #10b981 100%);
      --secondary-gradient: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      --input-bg: #1e293b;
      --input-border: #334155;
      --input-focus: #34d399;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
      --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.6);
      --nav-bg: rgba(30, 41, 59, 0.9);
      --nav-hover: rgba(52, 211, 153, 0.1);
      --progress-bg: rgba(52, 211, 153, 0.1);
      --progress-fill: #34d399;
      --glow: rgba(52, 211, 153, 0.5);
      --route-color: #34d399;
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Inter', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      position: relative;
      transition: all 0.3s ease;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      height: var(--tg-viewport-height);
    }

    body::before {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: var(--bg-gradient);
      opacity: 0.03;
      z-index: -2;
      animation: gradientAnimation 20s ease-in-out infinite;
    }

    @keyframes gradientAnimation {
      0%, 100% { transform: rotate(0deg); }
      50% { transform: rotate(180deg); }
    }

    .content-wrapper {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      display: flex;
      flex-direction: column;
      padding-bottom: 60px; /* Space for fixed buttons */
    }

    .lang-switch {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 8px;
      z-index: 1000;
    }

    .lang-switch button {
      background: var(--card-bg);
      color: var(--text-primary);
      border: 1px solid var(--card-border);
      border-radius: 50px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
    }

    .lang-switch button.active {
      background: var(--accent-gradient);
      color: white;
      border-color: transparent;
    }

    .page {
      display: none;
      width: 100%;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 24px 24px 0 0;
      box-shadow: var(--shadow-xl);
      padding: 32px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      position: relative;
      overflow: hidden;
      transition: all 0.4s ease;
      animation: pageIn 0.5s ease-out;
      flex: 1;
      margin-top: 20px;
    }

    @keyframes pageIn {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .page.active { 
      display: block; 
    }

    .fixed-bottom-buttons {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border-top: 1px solid var(--card-border);
      padding: 12px 20px;
      box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.07);
      z-index: 100;
      display: none;
    }

    .fixed-bottom-buttons.active {
      display: block;
    }

    #mapContainer {
      width: 100%;
      height: 300px;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      margin-bottom: 20px;
      position: relative;
    }

    #clientMap {
      width: 100%;
      height: 100%;
    }

    .route-info {
      position: absolute;
      top: 10px;
      left: 10px;
      background: var(--card-bg);
      padding: 10px 15px;
      border-radius: 10px;
      font-size: 0.9rem;
      box-shadow: var(--shadow-md);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    h1 {
      margin-bottom: 20px;
      font-size: 1.5rem;
      font-weight: 800;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1.3;
      letter-spacing: -0.02em;
      text-align: center;
    }

    .welcome-icon {
      font-size: 4rem;
      margin-bottom: 24px;
      display: inline-block;
      animation: float 3s ease-in-out infinite;
      filter: drop-shadow(0 10px 20px rgba(16, 185, 129, 0.3));
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .welcome-subtitle {
      color: var(--text-secondary);
      margin-bottom: 32px;
      font-size: 1.1rem;
      line-height: 1.6;
      font-weight: 400;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: none;
      border-radius: 12px;
      padding: 16px 32px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      text-decoration: none;
      background: var(--accent-gradient);
      color: white;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
      width: 100%;
      letter-spacing: 0.02em;
    }

    .btn-secondary {
      background: var(--secondary-gradient);
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .btn:active {
      transform: translateY(-1px);
    }

    form { 
      text-align: left; 
    }

    .form-group { 
      margin-bottom: 24px;
      position: relative;
    }

    label { 
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.95rem;
      letter-spacing: 0.01em;
    }

    label .emoji {
      font-size: 1.2rem;
    }

    input[type="text"], 
    input[type="tel"],
    input[type="number"], 
    input[type="file"],
    textarea {
      width: 100%;
      padding: 14px 18px;
      font-size: 1rem;
      border: 2px solid var(--input-border);
      border-radius: 12px;
      background: var(--input-bg);
      color: var(--text-primary);
      transition: all 0.3s ease;
      font-weight: 500;
      font-family: inherit;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--input-focus);
      background: var(--card-bg);
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
      transform: translateY(-2px);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    input[type="file"] {
      padding: 12px;
      cursor: pointer;
      border: 2px dashed var(--input-border);
      background: var(--input-bg);
      position: relative;
      transition: all 0.3s ease;
    }

    input[type="file"]:hover {
      border-color: var(--input-focus);
      background: var(--card-bg);
    }

    input[type="file"]::file-selector-button {
      background: var(--accent-gradient);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      margin-right: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .address-input-container {
      position: relative;
    }

    .address-input {
      width: 100%;
      padding-right: 50px;
    }

    .map-picker-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--accent-gradient);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .map-picker-btn:hover {
      transform: translateY(-50%) scale(1.1);
    }

    .suggestions-container {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border: 1px solid var(--input-border);
      border-radius: 8px;
      margin-top: 5px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      box-shadow: var(--shadow-lg);
    }

    .suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid var(--input-border);
    }

    .suggestion-item:hover {
      background: var(--nav-hover);
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .truck-types {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 15px;
      margin-top: 10px;
    }

    .truck-type {
      text-align: center;
      padding: 20px 10px;
      border: 2px solid var(--input-border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: var(--input-bg);
    }

    .truck-type:hover {
      border-color: var(--accent-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .truck-type.selected {
      border-color: var(--accent-primary);
      background: var(--nav-hover);
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
    }

    .truck-icon {
      font-size: 2.5rem;
      margin-bottom: 8px;
      display: block;
    }

    .truck-name {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .price-input {
      position: relative;
    }

    .price-input input {
      padding-right: 50px;
    }

    .price-currency {
      position: absolute;
      right: 18px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-weight: 600;
    }

    .optional-field {
      position: relative;
    }

    .optional-label {
      position: absolute;
      right: 0;
      top: 0;
      font-size: 0.8rem;
      color: var(--text-muted);
      font-weight: 400;
    }

    #previewContent {
      background: var(--input-bg);
      border-radius: 16px;
      padding: 24px;
      margin: 24px 0;
      border: 1px solid var(--input-border);
    }

    .preview-item { 
      margin-bottom: 16px;
      padding: 16px;
      background: var(--card-bg);
      border-radius: 12px;
      border-left: 4px solid var(--input-focus);
      transition: all 0.3s ease;
    }

    .preview-item:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-md);
    }

    .preview-item strong {
      color: var(--accent-primary);
      display: block;
      margin-bottom: 6px;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .preview-item img {
      display: block;
      max-width: 200px;
      height: 150px;
      object-fit: cover;
      margin-top: 12px;
      border-radius: 12px;
      box-shadow: var(--shadow-md);
      transition: transform 0.3s ease;
    }

    .preview-item img:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg);
    }

    .route-preview {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }

    .route-arrow {
      color: var(--accent-primary);
      font-size: 1.5rem;
    }

    .form-progress {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--progress-bg);
      overflow: hidden;
    }

    .form-progress::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: var(--accent-gradient);
      transition: width 0.5s ease;
      width: 0%;
      box-shadow: 0 0 10px var(--glow);
    }

    #step1 .form-progress::before { width: 25%; }
    #step2 .form-progress::before { width: 50%; }
    #step3 .form-progress::before { width: 75%; }
    #step4 .form-progress::before { width: 100%; }

    .button-group {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 24px;
    }

    .nav-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: var(--nav-bg);
      color: var(--text-primary);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 12px 24px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      min-width: 120px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .nav-btn:hover {
      background: var(--nav-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .success-page {
      text-align: center;
      padding: 40px 20px;
    }

    .success-icon {
      font-size: 4rem;
      margin-bottom: 24px;
      display: inline-block;
      animation: float 3s ease-in-out infinite;
      filter: drop-shadow(0 10px 20px rgba(16, 185, 129, 0.3));
    }

    .success-subtitle {
      color: var(--text-secondary);
      margin-bottom: 32px;
      font-size: 1.1rem;
      line-height: 1.6;
      font-weight: 400;
    }

    /* Driver List */
    .drivers-container {
      margin-top: 20px;
    }

    .driver-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      transition: all 0.3s ease;
      cursor: pointer;
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .driver-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      border-color: var(--accent-primary);
    }

    .driver-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: var(--shadow-sm);
    }

    .driver-info {
      flex: 1;
    }

    .driver-name {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 5px;
    }

    .driver-route {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-bottom: 5px;
    }

    .driver-price {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--accent-primary);
      text-align: right;
    }

    /* Driver Detail Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card-bg);
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { transform: translate(-50%, -40%); opacity: 0; }
      to { transform: translate(-50%, -50%); opacity: 1; }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
      transition: color 0.3s;
    }

    .close-btn:hover {
      color: var(--text-primary);
    }

    .detail-section {
      margin-bottom: 20px;
      padding: 15px;
      background: var(--input-bg);
      border-radius: 12px;
    }

    .detail-label {
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 5px;
      font-size: 0.9rem;
    }

    .detail-value {
      color: var(--text-primary);
      font-size: 1.05rem;
    }

    #detailMap {
      width: 100%;
      height: 250px;
      border-radius: 12px;
      margin: 20px 0;
    }

    .contact-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .contact-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 10px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .call-btn {
      background: var(--accent-gradient);
      color: white;
    }

    .whatsapp-btn {
      background: #25D366;
      color: white;
    }

    .telegram-btn {
      background: #0088cc;
      color: white;
    }

    .contact-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .driver-photo {
      width: 100%;
      text-align: center;
      margin-bottom: 20px;
    }

    .driver-photo img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: var(--shadow-lg);
    }

    .truck-photo {
      width: 100%;
      max-height: 300px;
      object-fit: cover;
      border-radius: 12px;
      margin: 15px 0;
    }

    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 20px 0;
      padding: 15px;
      background: var(--input-bg);
      border-radius: 10px;
      cursor: pointer;
    }

    .checkbox-container input[type="checkbox"] {
      width: 24px;
      height: 24px;
      cursor: pointer;
    }

    .checkbox-container label {
      margin: 0;
      cursor: pointer;
      font-weight: 500;
    }

    .offerta-container {
      max-height: 400px;
      overflow-y: auto;
      padding: 20px;
      background: var(--input-bg);
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid var(--input-border);
    }

    .offerta-container h2 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      color: var(--accent-primary);
    }

    .offerta-container p {
      margin-bottom: 12px;
      line-height: 1.6;
      color: var(--text-secondary);
    }

    /* Loading state */
    .loading {
      pointer-events: none;
      opacity: 0.6;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 40px;
      height: 40px;
      margin: -20px 0 0 -20px;
      border: 3px solid var(--input-border);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-icon {
      font-size: 3rem;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-text {
      color: var(--text-muted);
      font-size: 1.1rem;
    }

    /* User location marker styles */
    .user-location-marker {
      position: absolute;
      width: 20px;
      height: 20px;
      background: #3b82f6;
      border: 3px solid white;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transform: translate(-50%, -50%);
    }

    .user-location-marker::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 40px;
      height: 40px;
      background: rgba(59, 130, 246, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        transform: translate(-50%, -50%) scale(0.5);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) scale(2);
        opacity: 0;
      }
    }

    /* Mobile */
    @media (max-width: 480px) {
      .content-wrapper {
        padding-bottom: 60px;
      }

      .lang-switch {
        top: 12px;
        right: 12px;
      }

      .lang-switch button {
        padding: 6px 14px;
        font-size: 0.8rem;
      }

      .page {
        padding: 24px 20px;
        border-radius: 20px 20px 0 0;
        margin-top: 10px;
      }

      h1 {
        font-size: 1.3rem;
        margin-bottom: 16px;
      }

      #mapContainer {
        height: 250px;
      }

      .btn {
        padding: 14px 24px;
        font-size: 0.95rem;
      }

      .form-group {
        margin-bottom: 20px;
      }

      input[type="text"],
      input[type="tel"],
      input[type="number"],
      input[type="file"],
      textarea {
        padding: 12px 16px;
        font-size: 16px; /* Prevents zoom on iOS */
      }

      .truck-types {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .truck-type {
        padding: 15px 5px;
      }

      .truck-icon {
        font-size: 2rem;
      }

      .button-group {
        flex-direction: column;
        gap: 10px;
      }

      .nav-btn {
        width: 100%;
      }

      .modal-content {
        width: 95%;
        padding: 20px;
      }

      .contact-buttons {
        flex-direction: column;
      }

      .driver-card {
        padding: 15px;
      }

      .driver-avatar {
        width: 50px;
        height: 50px;
      }
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://api-maps.yandex.ru/2.1/?apikey=8a3e4da0-9ef2-4176-9203-e7014c1dba6f&lang=ru_RU" type="text/javascript"></script>
</head>
<body>
  <div class="lang-switch">
    <button onclick="setLang('ru')" id="lang-ru" class="active">RU</button>
    <button onclick="setLang('kz')" id="lang-kz">KZ</button>
  </div>

  <div class="content-wrapper">
    <!-- Step 0: Check Registration -->
    <div id="step0" class="page active">
      <div style="text-align: center; padding: 40px 20px;">
        <div class="welcome-icon">📦</div>
        <h1 data-ru="Проверка регистрации..." data-kz="Тіркелуді тексеру...">Проверка регистрации...</h1>
        <p class="welcome-subtitle" data-ru="Пожалуйста, подождите" data-kz="Күте тұрыңыз">Пожалуйста, подождите</p>
      </div>
    </div>

    <!-- Step 1: Offerta -->
    <div id="step1" class="page">
      <div class="form-progress"></div>
      <h1 data-ru="Пользовательское соглашение" data-kz="Пайдаланушы келісімі">Пользовательское соглашение</h1>
      <div class="offerta-container">
        <h2 data-ru="Оферта для клиентов" data-kz="Клиенттерге арналған оферта">Оферта для клиентов</h2>
        <p data-ru="Настоящее Пользовательское соглашение (далее — Соглашение) регулирует отношения между администрацией сервиса логистики (далее — Сервис) и клиентом (далее — Пользователь)."
           data-kz="Осы Пайдаланушы келісімі (бұдан әрі — Келісім) логистика қызметінің әкімшілігі (бұдан әрі — Қызмет) мен клиент (бұдан әрі — Пайдаланушы) арасындағы қатынастарды реттейді.">
          Настоящее Пользовательское соглашение (далее — Соглашение) регулирует отношения между администрацией сервиса логистики (далее — Сервис) и клиентом (далее — Пользователь).
        </p>
        <p data-ru="1. Предмет соглашения. Сервис предоставляет платформу для поиска водителей и заказа услуг грузоперевозки."
           data-kz="1. Келісімнің мәні. Қызмет жүргізушілерді іздеу және жүк тасымалдау қызметтеріне тапсырыс беру үшін платформа ұсынады.">
          1. Предмет соглашения. Сервис предоставляет платформу для поиска водителей и заказа услуг грузоперевозки.
        </p>
        <p data-ru="2. Права и обязанности клиента. Клиент обязуется предоставить достоверную информацию о грузе, маршруте и контактных данных."
           data-kz="2. Клиенттің құқықтары мен міндеттері. Клиент жүк, маршрут және байланыс деректері туралы дұрыс ақпарат беруге міндеттенеді.">
          2. Права и обязанности клиента. Клиент обязуется предоставить достоверную информацию о грузе, маршруте и контактных данных.
        </p>
        <p data-ru="3. Ответственность. Клиент несет ответственность за достоверность предоставленной информации и своевременную оплату услуг."
           data-kz="3. Жауапкершілік. Клиент берілген ақпараттың дұрыстығы және қызметтерді уақтылы төлеу үшін жауапты.">
          3. Ответственность. Клиент несет ответственность за достоверность предоставленной информации и своевременную оплату услуг.
        </p>
        <p data-ru="4. Оплата услуг. Оплата производится напрямую водителю согласно договоренности."
           data-kz="4. Қызметтерді төлеу. Төлем келісім бойынша жүргізушіге тікелей жүргізіледі.">
          4. Оплата услуг. Оплата производится напрямую водителю согласно договоренности.
        </p>
        <p data-ru="5. Конфиденциальность. Сервис обязуется не разглашать персональные данные клиента третьим лицам."
           data-kz="5. Құпиялылық. Қызмет клиенттің жеке деректерін үшінші тұлғаларға жарияламауға міндеттенеді.">
          5. Конфиденциальность. Сервис обязуется не разглашать персональные данные клиента третьим лицам.
        </p>
      </div>
      <div class="checkbox-container">
        <input type="checkbox" id="acceptOfferta">
        <label for="acceptOfferta" data-ru="Я прочитал и принимаю условия соглашения" data-kz="Мен келісім шарттарын оқыдым және қабылдаймын">Я прочитал и принимаю условия соглашения</label>
      </div>
      <button id="continueToForm" class="btn" disabled>
        <span>✅</span>
        <span data-ru="Продолжить" data-kz="Жалғастыру">Продолжить</span>
      </button>
    </div>

    <!-- Step 2: Request Form -->
    <div id="step2" class="page">
      <div class="form-progress"></div>
      <h1 data-ru="Заказать доставку" data-kz="Жеткізуге тапсырыс беру">Заказать доставку</h1>
      
      <div id="mapContainer">
        <div id="clientMap"></div>
        <div class="route-info" id="routeInfo" style="display: none;">
          <span id="routeDistance"></span>
        </div>
      </div>
      
      <form id="clientForm">
        <div class="form-group">
          <label for="from_address">
            <span class="emoji">📍</span>
            <span data-ru="Откуда" data-kz="Қайдан">Откуда</span>
          </label>
          <div class="address-input-container">
            <input type="text" id="from_address" name="from_address" class="address-input" 
                   placeholder="Введите адрес или выберите на карте" required>
            <button type="button" class="map-picker-btn" onclick="selectOnMap('from')">📍</button>
          </div>
          <div id="from_suggestions" class="suggestions-container" style="display: none;"></div>
        </div>
        
        <div class="form-group">
          <label for="to_address">
            <span class="emoji">🎯</span>
            <span data-ru="Куда" data-kz="Қайда">Куда</span>
          </label>
          <div class="address-input-container">
            <input type="text" id="to_address" name="to_address" class="address-input" 
                   placeholder="Введите адрес или выберите на карте" required>
            <button type="button" class="map-picker-btn" onclick="selectOnMap('to')">📍</button>
          </div>
          <div id="to_suggestions" class="suggestions-container" style="display: none;"></div>
        </div>
        
        <div class="form-group">
          <label for="price">
            <span class="emoji">💰</span>
            <span data-ru="Цена" data-kz="Бағасы">Цена</span>
          </label>
          <div class="price-input">
            <input type="number" id="price" name="price" min="2000" placeholder="Минимум 2000" required>
            <span class="price-currency">₸</span>
          </div>
        </div>
        
        <div class="form-group">
          <label>
            <span class="emoji">🚚</span>
            <span data-ru="Тип транспорта" data-kz="Көлік түрі">Тип транспорта</span>
          </label>
          <div class="truck-types">
            <div class="truck-type" data-type="small">
              <span class="truck-icon">🚐</span>
              <span class="truck-name" data-ru="Малый" data-kz="Кіші">Малый</span>
            </div>
            <div class="truck-type" data-type="medium">
              <span class="truck-icon">🚚</span>
              <span class="truck-name" data-ru="Средний" data-kz="Орта">Средний</span>
            </div>
            <div class="truck-type" data-type="large">
              <span class="truck-icon">🚛</span>
              <span class="truck-name" data-ru="Большой" data-kz="Үлкен">Большой</span>
            </div>
            <div class="truck-type" data-type="refrigerator">
              <span class="truck-icon">❄️</span>
              <span class="truck-name" data-ru="Рефрижератор" data-kz="Рефрижератор">Рефрижератор</span>
            </div>
            <div class="truck-type" data-type="tow">
              <span class="truck-icon">🚗</span>
              <span class="truck-name" data-ru="Эвакуатор" data-kz="Эвакуатор">Эвакуатор</span>
            </div>
          </div>
          <input type="hidden" name="truck_type" id="truck_type" required>
        </div>
        
        <div class="form-group">
          <label for="comment">
            <span class="emoji">💬</span>
            <span data-ru="Комментарий" data-kz="Түсініктеме">Комментарий</span>
          </label>
          <textarea id="comment" name="comment" 
                    placeholder="Дополнительная информация о грузе"></textarea>
        </div>
        
        <div class="form-group optional-field">
          <label for="item_photo">
            <span class="emoji">📸</span>
            <span data-ru="Фото груза" data-kz="Жүк фотосы">Фото груза</span>
            <span class="optional-label" data-ru="(необязательно)" data-kz="(міндетті емес)">(необязательно)</span>
          </label>
          <input type="file" id="item_photo" name="item_photo" accept="image/*">
        </div>
        
        <div class="form-group">
          <label for="contact">
            <span class="emoji">📱</span>
            <span data-ru="Контактный номер" data-kz="Байланыс нөмірі">Контактный номер</span>
          </label>
          <input type="tel" id="contact" name="contact" placeholder="+7 (___) ___-__-__" required>
        </div>
        
        <input type="hidden" name="from_lat" id="from_lat">
        <input type="hidden" name="from_lon" id="from_lon">
        <input type="hidden" name="to_lat" id="to_lat">
        <input type="hidden" name="to_lon" id="to_lon">
        <input type="hidden" name="telegram_id" id="telegram_id">
      </form>
    </div>

    <!-- Step 3: Preview -->
    <div id="step3" class="page">
      <div class="form-progress"></div>
      <h1 data-ru="Проверьте данные" data-kz="Деректерді тексеріңіз">Проверьте данные</h1>
      <div id="previewContent"></div>
    </div>

    <!-- Step 4: Success & Drivers List -->
    <div id="step4" class="page">
      <div class="success-page">
        <div class="success-icon">✅</div>
        <h1 data-ru="Заявка создана!" data-kz="Өтінім жасалды!">Заявка создана!</h1>
        <p class="success-subtitle" data-ru="Подходящие водители" data-kz="Қолайлы жүргізушілер">Подходящие водители</p>
      </div>
      
      <div id="driversList" class="drivers-container">
        <!-- Drivers will be loaded here -->
      </div>
      
      <div class="button-group" style="margin-top: 30px;">
        <button class="btn btn-secondary" onclick="Telegram.WebApp.close()">
          <span>❌</span>
          <span data-ru="Закрыть" data-kz="Жабу">Закрыть</span>
        </button>
      </div>
    </div>
  </div>

  <div class="fixed-bottom-buttons" id="fixedButtons">
    <div class="button-group">
      <button type="button" id="backBtn" class="nav-btn" style="display: none;">← <span data-ru="Назад" data-kz="Артқа">Назад</span></button>
    </div>
  </div>

  <!-- Driver Detail Modal -->
  <div id="driverModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 data-ru="Информация о водителе" data-kz="Жүргізуші туралы ақпарат">Информация о водителе</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      
      <div id="modalContent">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>

  <script>
    // Set Telegram viewport height
    function updateViewportHeight() {
      const vh = Telegram.WebApp.viewportHeight;
      document.documentElement.style.setProperty('--tg-viewport-height', `${vh}px`);
    }

    // Update on init and resize
    updateViewportHeight();
    Telegram.WebApp.onEvent('viewportChanged', updateViewportHeight);

    // Language management
    let currentLang = 'ru';
    const translations = {
      ru: {
        checking: 'Проверка регистрации...',
        pleaseWait: 'Пожалуйста, подождите',
        offertaTitle: 'Пользовательское соглашение',
        acceptTerms: 'Я прочитал и принимаю условия соглашения',
        continue: 'Продолжить',
        orderDelivery: 'Заказать доставку',
        from: 'Откуда',
        to: 'Куда',
        price: 'Цена',
        truckType: 'Тип транспорта',
        comment: 'Комментарий',
        itemPhoto: 'Фото груза',
        optional: '(необязательно)',
        contactNumber: 'Контактный номер',
        back: 'Назад',
        checkData: 'Проверить данные',
        confirm: 'Подтвердить',
        requestCreated: 'Заявка создана!',
        suitableDrivers: 'Подходящие водители',
        close: 'Закрыть',
        enterAddress: 'Введите адрес или выберите на карте',
        minimum: 'Минимум',
        additionalInfo: 'Дополнительная информация о грузе',
        selectOnMap: 'Выберите точку на карте',
        routeDistance: 'Расстояние',
        driverInfo: 'Информация о водителе',
        contact: 'Контакт',
        call: 'Позвонить',
        noDrivers: 'Нет доступных водителей',
        loading: 'Загрузка...',
        error: 'Ошибка',
        fillAllFields: 'Заполните все обязательные поля',
        minPrice: 'Минимальная цена 2000 ₸',
        selectTruck: 'Выберите тип транспорта',
        small: 'Малый',
        medium: 'Средний',
        large: 'Большой',
        refrigerator: 'Рефрижератор',
        tow: 'Эвакуатор',
        departureTime: 'Время отправления',
        acceptOfferta: 'Пожалуйста, примите условия соглашения',
        truckPhoto: 'Фото транспорта',
        driverComment: 'Комментарий водителя',
        followingYou: 'Отслеживаем ваше местоположение',
        locationDenied: 'Разрешите доступ к геолокации для лучшей работы'
      },
      kz: {
        checking: 'Тіркелуді тексеру...',
        pleaseWait: 'Күте тұрыңыз',
        offertaTitle: 'Пайдаланушы келісімі',
        acceptTerms: 'Мен келісім шарттарын оқыдым және қабылдаймын',
        continue: 'Жалғастыру',
        orderDelivery: 'Жеткізуге тапсырыс беру',
        from: 'Қайдан',
        to: 'Қайда',
        price: 'Бағасы',
        truckType: 'Көлік түрі',
        comment: 'Түсініктеме',
        itemPhoto: 'Жүк фотосы',
        optional: '(міндетті емес)',
        contactNumber: 'Байланыс нөмірі',
        back: 'Артқа',
        checkData: 'Деректерді тексеру',
        confirm: 'Растау',
        requestCreated: 'Өтінім жасалды!',
        suitableDrivers: 'Қолайлы жүргізушілер',
        close: 'Жабу',
        enterAddress: 'Мекенжайды енгізіңіз немесе картадан таңдаңыз',
        minimum: 'Минимум',
        additionalInfo: 'Жүк туралы қосымша ақпарат',
        selectOnMap: 'Картадан нүктені таңдаңыз',
        routeDistance: 'Қашықтық',
        driverInfo: 'Жүргізуші туралы ақпарат',
        contact: 'Байланыс',
        call: 'Қоңырау шалу',
        noDrivers: 'Қол жетімді жүргізушілер жоқ',
        loading: 'Жүктелуде...',
        error: 'Қате',
        fillAllFields: 'Барлық міндетті өрістерді толтырыңыз',
        minPrice: 'Минималды баға 2000 ₸',
        selectTruck: 'Көлік түрін таңдаңыз',
        small: 'Кіші',
        medium: 'Орта',
        large: 'Үлкен',
        refrigerator: 'Рефрижератор',
        tow: 'Эвакуатор',
        departureTime: 'Жөнелу уақыты',
        acceptOfferta: 'Келісім шарттарын қабылдаңыз',
        truckPhoto: 'Көлік фотосы',
        driverComment: 'Жүргізуші түсініктемесі',
        followingYou: 'Сіздің орналасқан жеріңізді бақылап отырмыз',
        locationDenied: 'Жақсы жұмыс істеу үшін геолокацияға рұқсат беріңіз'
      }
    };

    function setLang(lang) {
      currentLang = lang;
      document.querySelectorAll('.lang-switch button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById('lang-' + lang).classList.add('active');
      
      // Update all elements with data attributes
      document.querySelectorAll('[data-ru]').forEach(el => {
        el.textContent = el.getAttribute('data-' + lang) || el.textContent;
      });
      
      // Update placeholders
      document.getElementById('from_address').placeholder = translations[lang].enterAddress;
      document.getElementById('to_address').placeholder = translations[lang].enterAddress;
      document.getElementById('price').placeholder = translations[lang].minimum + ' 2000';
      document.getElementById('comment').placeholder = translations[lang].additionalInfo;
      
      // Update main button text based on current step
      updateMainButtonText();
    }

    // Theme management
    function detectSystemTheme() {
      const hour = new Date().getHours();
      return (hour >= 20 || hour < 6) ? 'dark' : 'light';
    }

    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
    }

    let currentTheme = detectSystemTheme();
    applyTheme(currentTheme);

    setInterval(() => {
      const newTheme = detectSystemTheme();
      if (newTheme !== currentTheme) {
        currentTheme = newTheme;
        applyTheme(currentTheme);
      }
    }, 60000);

    // Telegram WebApp initialization
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
    
    const user = Telegram.WebApp.initDataUnsafe?.user;
    if (user) {
      document.getElementById('telegram_id').value = user.id;
    }

    // Theme from Telegram
    if (Telegram.WebApp.colorScheme) {
      currentTheme = Telegram.WebApp.colorScheme;
      applyTheme(currentTheme);
    }

    Telegram.WebApp.onEvent('themeChanged', function() {
      if (Telegram.WebApp.colorScheme) {
        currentTheme = Telegram.WebApp.colorScheme;
        applyTheme(currentTheme);
      }
    });

    // Yandex Maps with real-time tracking
    let clientMap;
    let fromPlacemark, toPlacemark;
    let userLocationPlacemark;
    let routeLine;
    let selectingPoint = null;
    let watchId;

    ymaps.ready(initClientMap);

    function initClientMap() {
      // Request geolocation with high accuracy
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            initMapWithPosition([position.coords.latitude, position.coords.longitude]);
            startLocationTracking();
          },
          (error) => {
            console.error('Geolocation error:', error);
            initMapWithPosition([43.238949, 76.889709]); // Default to Almaty
            Telegram.WebApp.showAlert(translations[currentLang].locationDenied);
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          }
        );
      } else {
        initMapWithPosition([43.238949, 76.889709]); // Default to Almaty
      }
    }

    function initMapWithPosition(center) {
      clientMap = new ymaps.Map("clientMap", {
        center: center,
        zoom: 14,
        controls: [] // Remove all default controls
      });

      // Add only zoom control
      clientMap.controls.add('zoomControl', {
        position: {
          right: 10,
          top: 10
        }
      });

      // Customize map behavior
      clientMap.behaviors.disable(['scrollZoom']); // Disable scroll zoom
      
      // Add user location marker
      addUserLocationMarker(center);

      // Add click handler for map selection
      clientMap.events.add('click', function (e) {
        if (selectingPoint) {
          const coords = e.get('coords');
          setPoint(selectingPoint, coords);
          getAddress(coords, selectingPoint);
          selectingPoint = null;
        }
      });
    }

    function addUserLocationMarker(coords) {
      userLocationPlacemark = new ymaps.Placemark(coords, {
        hintContent: translations[currentLang].followingYou
      }, {
        iconLayout: 'default#imageWithContent',
        iconImageHref: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMCIgaGVpZ2h0PSIzMCIgdmlld0JveD0iMCAwIDMwIDMwIj4KICA8Y2lyY2xlIGN4PSIxNSIgY3k9IjE1IiByPSIxMCIgZmlsbD0iIzNiODJmNiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIzIi8+CiAgPGNpcmNsZSBjeD0iMTUiIGN5PSIxNSIgcj0iNCIgZmlsbD0id2hpdGUiLz4KPC9zdmc+',
        iconImageSize: [30, 30],
        iconImageOffset: [-15, -15],
        iconContentLayout: ymaps.templateLayoutFactory.createClass(
          '<div class="user-location-marker"></div>'
        )
      });

      clientMap.geoObjects.add(userLocationPlacemark);
    }

    function startLocationTracking() {
      if (navigator.geolocation) {
        watchId = navigator.geolocation.watchPosition(
          (position) => {
            const newCoords = [position.coords.latitude, position.coords.longitude];
            if (userLocationPlacemark) {
              userLocationPlacemark.geometry.setCoordinates(newCoords);
              
              // Smoothly pan to new location if user moved significantly
              const currentCenter = clientMap.getCenter();
              const distance = ymaps.coordSystem.geo.getDistance(currentCenter, newCoords);
              
              if (distance > 100) { // If moved more than 100 meters
                clientMap.panTo(newCoords, {
                  duration: 500,
                  checkZoomRange: true
                });
              }
            }
          },
          (error) => {
            console.error('Location tracking error:', error);
          },
          {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
          }
        );
      }
    }

    function selectOnMap(type) {
      selectingPoint = type;
      Telegram.WebApp.showAlert(translations[currentLang].selectOnMap);
    }

    function setPoint(type, coords) {
      if (type === 'from') {
        if (fromPlacemark) {
          clientMap.geoObjects.remove(fromPlacemark);
        }
        fromPlacemark = new ymaps.Placemark(coords, {
          hintContent: translations[currentLang].from
        }, {
          preset: 'islands#greenIcon',
          draggable: true
        });
        clientMap.geoObjects.add(fromPlacemark);
        
        fromPlacemark.events.add('dragend', function () {
          const newCoords = fromPlacemark.geometry.getCoordinates();
          getAddress(newCoords, 'from');
          updateRoute();
        });
        
        document.getElementById('from_lat').value = coords[0];
        document.getElementById('from_lon').value = coords[1];
      } else {
        if (toPlacemark) {
          clientMap.geoObjects.remove(toPlacemark);
        }
        toPlacemark = new ymaps.Placemark(coords, {
          hintContent: translations[currentLang].to
        }, {
          preset: 'islands#redIcon',
          draggable: true
        });
        clientMap.geoObjects.add(toPlacemark);
        
        toPlacemark.events.add('dragend', function () {
          const newCoords = toPlacemark.geometry.getCoordinates();
          getAddress(newCoords, 'to');
          updateRoute();
        });
        
        document.getElementById('to_lat').value = coords[0];
        document.getElementById('to_lon').value = coords[1];
      }
      
      updateRoute();
    }

    function getAddress(coords, type) {
      ymaps.geocode(coords, {
        kind: 'house',
        results: 1
      }).then(function (res) {
        const firstGeoObject = res.geoObjects.get(0);
        const address = firstGeoObject.getAddressLine();
        
        if (type === 'from') {
          document.getElementById('from_address').value = address;
        } else {
          document.getElementById('to_address').value = address;
        }
      });
    }

    function updateRoute() {
      if (fromPlacemark && toPlacemark) {
        if (routeLine) {
          clientMap.geoObjects.remove(routeLine);
        }
        
        const fromCoords = fromPlacemark.geometry.getCoordinates();
        const toCoords = toPlacemark.geometry.getCoordinates();
        
        ymaps.route([fromCoords, toCoords], {
          mapStateAutoApply: true,
          multiRoute: false
        }).then(function (route) {
          routeLine = route;
          routeLine.getPaths().options.set({
            strokeColor: '10b981FF',
            strokeWidth: 5,
            opacity: 0.8
          });
          clientMap.geoObjects.add(routeLine);
          
          // Show distance
          const distance = route.getLength();
          const distanceKm = (distance / 1000).toFixed(1);
          document.getElementById('routeDistance').textContent = 
            translations[currentLang].routeDistance + ': ' + distanceKm + ' км';
          document.getElementById('routeInfo').style.display = 'block';
        });
      }
    }

    // Address suggestions with Kazakhstan priority
    let suggestTimeout;
    
    function setupAddressSuggestions(fieldId) {
      const input = document.getElementById(fieldId);
      const suggestionsId = fieldId + '_suggestions';
      
      input.addEventListener('input', function(e) {
        clearTimeout(suggestTimeout);
        const query = e.target.value;
        
        if (query.length < 3) {
          document.getElementById(suggestionsId).style.display = 'none';
          return;
        }
        
        suggestTimeout = setTimeout(() => {
          // Search with Kazakhstan bounds priority
          const searchPromise = ymaps.suggest(query, {
            boundedBy: [[41.15, 46.99], [55.44, 87.31]], // Kazakhstan bounds
            strictBounds: false,
            results: 10
          });
          
          searchPromise.then(function (items) {
            // Filter and prioritize Kazakhstan results
            const kazakhstanItems = items.filter(item => 
              item.displayName.includes('Казахстан') || 
              item.displayName.includes('Kazakhstan') ||
              item.value.includes('Алматы') ||
              item.value.includes('Астана') ||
              item.value.includes('Нур-Султан')
            );
            
            const otherItems = items.filter(item => 
              !kazakhstanItems.includes(item)
            );
            
            const sortedItems = [...kazakhstanItems, ...otherItems];
            displaySuggestions(fieldId, sortedItems.slice(0, 5));
          });
        }, 300);
      });
    }

    setupAddressSuggestions('from_address');
    setupAddressSuggestions('to_address');

    function displaySuggestions(field, items) {
      const container = document.getElementById(field + '_suggestions');
      container.innerHTML = '';
      
      if (items.length === 0) {
        container.style.display = 'none';
        return;
      }
      
      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'suggestion-item';
        div.textContent = item.displayName;
        div.onclick = function() {
          document.getElementById(field).value = item.value;
          container.style.display = 'none';
          
          // Geocode to get coordinates
          ymaps.geocode(item.value, {
            results: 1
          }).then(function(res) {
            const firstGeoObject = res.geoObjects.get(0);
            const coords = firstGeoObject.geometry.getCoordinates();
            const type = field.includes('from') ? 'from' : 'to';
            setPoint(type, coords);
          });
        };
        container.appendChild(div);
      });
      
      container.style.display = 'block';
    }

    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.classList.contains('address-input')) {
        document.querySelectorAll('.suggestions-container').forEach(container => {
          container.style.display = 'none';
        });
      }
    });

    // Truck type selection
    document.querySelectorAll('.truck-type').forEach(type => {
      type.addEventListener('click', function() {
        document.querySelectorAll('.truck-type').forEach(t => t.classList.remove('selected'));
        this.classList.add('selected');
        document.getElementById('truck_type').value = this.dataset.type;
      });
    });

    // Step navigation
    let currentStep = 0;
    
    function show(step) {
      currentStep = step;
      [0,1,2,3,4].forEach(i => {
        const el = document.getElementById('step'+i);
        el.classList.toggle('active', i===step);
      });
      
      // Update fixed buttons
      const fixedButtons = document.getElementById('fixedButtons');
      const backBtn = document.getElementById('backBtn');
      
      if (step === 3) {
        fixedButtons.classList.add('active');
        backBtn.style.display = 'inline-flex';
      } else {
        fixedButtons.classList.remove('active');
      }
      
      Telegram.WebApp.MainButton.hide();
      updateMainButtonText();
      
      if (step === 4) {
        loadDrivers();
      }
    }

    function updateMainButtonText() {
      if (currentStep === 2) {
        Telegram.WebApp.MainButton.setText('📋 ' + translations[currentLang].checkData);
        Telegram.WebApp.MainButton.show();
        Telegram.WebApp.MainButton.color = '#10b981';
      } else if (currentStep === 3) {
        Telegram.WebApp.MainButton.setText('✅ ' + translations[currentLang].confirm);
        Telegram.WebApp.MainButton.show();
        Telegram.WebApp.MainButton.color = '#3b82f6';
      }
    }

    // Check if client exists
    async function checkClientExists() {
      try {
        const response = await fetch('/api/client/check', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            telegram_id: document.getElementById('telegram_id').value
          })
        });
        
        const data = await response.json();
        
        if (data.exists && data.offerta_accepted) {
          // Client already accepted offerta
          show(2);
        } else {
          // Show offerta
          show(1);
        }
      } catch (error) {
        console.error('Error checking client:', error);
        // Show offerta on error
        show(1);
      }
    }

    // Check on load
    setTimeout(checkClientExists, 1000);

    // Offerta acceptance
    document.getElementById('acceptOfferta').addEventListener('change', function() {
      document.getElementById('continueToForm').disabled = !this.checked;
    });

    document.getElementById('continueToForm').onclick = () => {
      if (document.getElementById('acceptOfferta').checked) {
        show(2);
      } else {
        Telegram.WebApp.showAlert(translations[currentLang].acceptOfferta);
      }
    };

    // Navigation handlers
    document.getElementById('backBtn').onclick = () => show(2);

    // Form validation and preview
    function buildPreview() {
      const f = document.getElementById('clientForm');
      if (!f.checkValidity()) { 
        f.reportValidity(); 
        return false; 
      }
      
      const price = parseInt(document.getElementById('price').value);
      if (price < 2000) {
        Telegram.WebApp.showAlert(translations[currentLang].minPrice);
        return false;
      }
      
      if (!document.getElementById('truck_type').value) {
        Telegram.WebApp.showAlert(translations[currentLang].selectTruck);
        return false;
      }
      
      const data = new FormData(f);
      let html = '';
      
      // Route
      html += `<div class="preview-item">
        <strong>${translations[currentLang].from} → ${translations[currentLang].to}</strong>
        <div class="route-preview">
          <div>
            <div class="from">${data.get('from_address')}</div>
            <div class="route-arrow">↓</div>
            <div class="to">${data.get('to_address')}</div>
          </div>
        </div>
      </div>`;
      
      // Price
      html += `<div class="preview-item">
        <strong>${translations[currentLang].price}</strong>
        ${data.get('price')} ₸
      </div>`;
      
      // Truck type
      const truckTypes = {
        'small': translations[currentLang].small,
        'medium': translations[currentLang].medium,
        'large': translations[currentLang].large,
        'refrigerator': translations[currentLang].refrigerator,
        'tow': translations[currentLang].tow
      };
      html += `<div class="preview-item">
        <strong>${translations[currentLang].truckType}</strong>
        ${truckTypes[data.get('truck_type')]}
      </div>`;
      
      // Comment
      if (data.get('comment')) {
        html += `<div class="preview-item">
          <strong>${translations[currentLang].comment}</strong>
          ${data.get('comment')}
        </div>`;
      }
      
      // Photo
      const photo = data.get('item_photo');
      if (photo && photo.name) {
        const url = URL.createObjectURL(photo);
        html += `<div class="preview-item">
          <strong>${translations[currentLang].itemPhoto}</strong>
          <img src="${url}" alt="item">
        </div>`;
      }
      
      // Contact
      html += `<div class="preview-item">
        <strong>${translations[currentLang].contactNumber}</strong>
        ${data.get('contact')}
      </div>`;
      
      document.getElementById('previewContent').innerHTML = html;
      return true;
    }

    // Main button handler
    Telegram.WebApp.onEvent('mainButtonClicked', () => {
      if (currentStep === 2) {
        if (buildPreview()) {
          show(3);
        }
      } else if (currentStep === 3) {
        submitRequest();
      }
    });

    // Submit request
    async function submitRequest() {
      document.getElementById('step3').classList.add('loading');
      Telegram.WebApp.MainButton.showProgress();
      
      const fd = new FormData(document.getElementById('clientForm'));
      
      try {
        const response = await fetch('/api/client/request', {
          method: 'POST',
          body: fd
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        Telegram.WebApp.MainButton.hideProgress();
        document.getElementById('step3').classList.remove('loading');
        
        if (result.success) {
          show(4);
        } else {
          Telegram.WebApp.showAlert(result.message || translations[currentLang].error);
        }
      } catch (error) {
        console.error('Error:', error);
        Telegram.WebApp.MainButton.hideProgress();
        document.getElementById('step3').classList.remove('loading');
        Telegram.WebApp.showAlert(translations[currentLang].error + ': ' + error.message);
      }
    }

    // Load drivers
    async function loadDrivers() {
      const container = document.getElementById('driversList');
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">⏳</div>
          <div class="empty-text">${translations[currentLang].loading}</div>
        </div>`;

      try {
        const response = await fetch(
          '/api/driver/matching?' +
            new URLSearchParams({
              from_lat: document.getElementById('from_lat').value,
              from_lon: document.getElementById('from_lon').value,
              to_lat: document.getElementById('to_lat').value,
              to_lon: document.getElementById('to_lon').value,
            })
        );

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.drivers && data.drivers.length > 0) {
          displayDrivers(data.drivers);
        } else {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">❌</div>
              <div class="empty-text">${translations[currentLang].noDrivers}</div>
            </div>`;
        }
      } catch (error) {
        console.error('Error loading drivers:', error);
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">❌</div>
            <div class="empty-text">
              ${translations[currentLang].error}: ${error.message}
            </div>
          </div>`;
      }
    }
    
    // Display drivers list
    function displayDrivers(drivers) {
      const container = document.getElementById('driversList');
      container.innerHTML = '';

      drivers.forEach(driver => {
        const card = document.createElement('div');
        card.className = 'driver-card';
        card.onclick = () => showDriverDetail(driver);

        card.innerHTML = `
          <img src="/files/${driver.profile_photo}" 
               alt="${driver.full_name}" 
               class="driver-avatar">
          <div class="driver-info">
            <div class="driver-name">${driver.full_name}</div>
            <div class="driver-route">
              <span>📍 ${driver.from_address}</span>
              <span>→</span>
              <span>🎯 ${driver.to_address}</span>
            </div>
            ${
              driver.comment
                ? `<div style="color: var(--text-muted); font-size: 0.9rem;">
                     💬 ${driver.comment.substring(0, 50)}...
                   </div>`
                : ``
            }
          </div>
          <div class="driver-price">${driver.price} ₸</div>
        `;

        container.appendChild(card);
      });
    }

    // Show driver detail modal
    let detailMap;
    function showDriverDetail(driver) {
      const modal = document.getElementById('driverModal');
      const content = document.getElementById('modalContent');
      
      content.innerHTML = `
        <div class="driver-photo">
          <img src="/files/${driver.profile_photo}" alt="${driver.full_name}">
        </div>
        
        <div class="detail-section">
          <div class="detail-label">${translations[currentLang].from} → ${translations[currentLang].to}</div>
          <div class="detail-value">
            <div>📍 ${driver.from_address}</div>
            <div style="text-align: center; color: var(--accent-primary);">↓</div>
            <div>🎯 ${driver.to_address}</div>
          </div>
        </div>
        
        <div id="detailMap"></div>
        
        <div class="detail-section">
          <div class="detail-label">${translations[currentLang].price}</div>
          <div class="detail-value" style="font-size: 1.5rem; color: var(--accent-primary); font-weight: 700;">
            ${driver.price} ₸
          </div>
        </div>
        
        <div class="detail-section">
          <div class="detail-label">${translations[currentLang].departureTime}</div>
          <div class="detail-value">
            ${new Date(driver.departure_time).toLocaleString(currentLang === 'ru' ? 'ru-RU' : 'kk-KZ')}
          </div>
        </div>
        
        ${driver.comment ? `
          <div class="detail-section">
            <div class="detail-label">${translations[currentLang].driverComment}</div>
            <div class="detail-value">${driver.comment}</div>
          </div>
        ` : ''}
        
        ${driver.truck_photo ? `
          <div class="detail-section">
            <div class="detail-label">${translations[currentLang].truckPhoto}</div>
            <img src="/files/${driver.truck_photo}" alt="Truck" class="truck-photo">
          </div>
        ` : ''}
        
        <div class="detail-section">
          <div class="detail-label">${translations[currentLang].contact}</div>
          <div class="detail-value">${driver.contact}</div>
        </div>
        
        <div class="contact-buttons">
          <button class="contact-btn call-btn" onclick="window.open('tel:${driver.contact}')">
            <span>📞</span>
            <span>${translations[currentLang].call}</span>
          </button>
          ${driver.has_whatsapp ? `
            <button class="contact-btn whatsapp-btn" onclick="window.open('https://wa.me/${driver.contact.replace(/\D/g, '')}')">
              <span>💬</span>
              <span>WhatsApp</span>
            </button>
          ` : ''}
          ${driver.has_telegram ? `
            <button class="contact-btn telegram-btn" onclick="window.open('https://t.me/${driver.telegram_username || driver.contact.replace(/\D/g, '')}')">
              <span>✈️</span>
              <span>Telegram</span>
            </button>
          ` : ''}
        </div>
      `;
      
      modal.style.display = 'block';
      
      // Initialize detail map
      setTimeout(() => {
        ymaps.ready(() => {
          detailMap = new ymaps.Map("detailMap", {
            center: [driver.from_lat, driver.from_lon],
            zoom: 12,
            controls: ['zoomControl']
          });
          
          // Add markers
          const fromMark = new ymaps.Placemark([driver.from_lat, driver.from_lon], {
            hintContent: translations[currentLang].from
          }, {
            preset: 'islands#greenIcon'
          });
          
          const toMark = new ymaps.Placemark([driver.to_lat, driver.to_lon], {
            hintContent: translations[currentLang].to
          }, {
            preset: 'islands#redIcon'
          });
          
          detailMap.geoObjects.add(fromMark);
          detailMap.geoObjects.add(toMark);
          
          // Draw route
          ymaps.route([
            [driver.from_lat, driver.from_lon],
            [driver.to_lat, driver.to_lon]
          ], {
            mapStateAutoApply: true,
            multiRoute: false
          }).then(function (route) {
            route.getPaths().options.set({
              strokeColor: '10b981FF',
              strokeWidth: 5,
              opacity: 0.8
            });
            detailMap.geoObjects.add(route);
          });
        });
      }, 100);
    }

    // Close modal
    function closeModal() {
      document.getElementById('driverModal').style.display = 'none';
      if (detailMap) {
        detailMap.destroy();
        detailMap = null;
      }
    }

    // Close modal on click outside
    document.getElementById('driverModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });

    // Phone formatting
    document.getElementById('contact').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      let formattedValue = '';
      
      if (value.length > 0) {
        formattedValue = '+7';
        if (value.length > 1) {
          formattedValue += ' (' + value.substring(1, 4);
          if (value.length > 4) {
            formattedValue += ') ' + value.substring(4, 7);
            if (value.length > 7) {
              formattedValue += '-' + value.substring(7, 9);
              if (value.length > 9) {
                formattedValue += '-' + value.substring(9, 11);
              }
            }
          } else if (value.length > 1) {
            formattedValue += ')';
          }
        }
      }
      
      e.target.value = formattedValue;
    });

    // File input visual feedback
    document.getElementById('item_photo').addEventListener('change', function(e) {
      if (e.target.files.length > 0) {
        e.target.style.borderColor = 'var(--accent-primary)';
        e.target.style.background = 'var(--card-bg)';
        
        const parent = e.target.parentElement;
        parent.style.transform = 'scale(0.98)';
        setTimeout(() => {
          parent.style.transform = 'scale(1)';
        }, 200);
      }
    });

    // Clean up location tracking on page unload
    window.addEventListener('beforeunload', () => {
      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
      }
    });

    // Make functions available globally
    window.selectOnMap = selectOnMap;
    window.closeModal = closeModal;
    window.setLang = setLang;

    // Initialize
    show(0);
  </script>
</body>
</html>