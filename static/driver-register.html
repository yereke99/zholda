<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–æ–¥–∏—Ç–µ–ª—è | –¢—ñ—Ä–∫–µ—É –∂“Ø—Ä–≥—ñ–∑—É—à—ñ</title>
  <style>
    :root {
      /* Light theme */
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-gradient: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      --card-bg: rgba(255, 255, 255, 0.98);
      --card-border: rgba(0, 0, 0, 0.06);
      --text-primary: #1a202c;
      --text-secondary: #4a5568;
      --text-muted: #718096;
      --accent-primary: #3b82f6;
      --accent-secondary: #10b981;
      --accent-gradient: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --input-bg: #f7fafc;
      --input-border: #e2e8f0;
      --input-focus: #3b82f6;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
      --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.15);
      --nav-bg: rgba(255, 255, 255, 0.9);
      --nav-hover: rgba(59, 130, 246, 0.1);
      --progress-bg: rgba(59, 130, 246, 0.1);
      --progress-fill: #3b82f6;
      --glow: rgba(59, 130, 246, 0.5);
      --tg-viewport-height: 100vh;
    }

    [data-theme="dark"] {
      /* Dark theme */
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-gradient: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
      --card-bg: rgba(30, 41, 59, 0.98);
      --card-border: rgba(255, 255, 255, 0.06);
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --accent-primary: #60a5fa;
      --accent-secondary: #34d399;
      --accent-gradient: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      --success-gradient: linear-gradient(135deg, #34d399 0%, #10b981 100%);
      --input-bg: #1e293b;
      --input-border: #334155;
      --input-focus: #60a5fa;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
      --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.6);
      --nav-bg: rgba(30, 41, 59, 0.9);
      --nav-hover: rgba(96, 165, 250, 0.1);
      --progress-bg: rgba(96, 165, 250, 0.1);
      --progress-fill: #60a5fa;
      --glow: rgba(96, 165, 250, 0.5);
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Inter', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      position: relative;
      transition: all 0.3s ease;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      height: var(--tg-viewport-height);
    }

    body::before {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: var(--bg-gradient);
      opacity: 0.03;
      z-index: -2;
      animation: gradientAnimation 20s ease-in-out infinite;
    }

    @keyframes gradientAnimation {
      0%, 100% { transform: rotate(0deg); }
      50% { transform: rotate(180deg); }
    }

    .content-wrapper {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      padding-bottom: 60px; /* Space for fixed buttons */
    }

    .lang-switch {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 8px;
      z-index: 1000;
    }

    .lang-switch button {
      background: var(--card-bg);
      color: var(--text-primary);
      border: 1px solid var(--card-border);
      border-radius: 50px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
    }

    .lang-switch button.active {
      background: var(--accent-gradient);
      color: white;
      border-color: transparent;
    }

    .page {
      display: none;
      width: 100%;
      max-width: 480px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 24px;
      box-shadow: var(--shadow-xl);
      padding: 32px;
      text-align: center;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      position: relative;
      overflow: hidden;
      transition: all 0.4s ease;
      animation: pageIn 0.5s ease-out;
      margin: auto;
    }

    @keyframes pageIn {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .page.active { 
      display: block; 
    }

    .fixed-bottom-buttons {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border-top: 1px solid var(--card-border);
      padding: 12px 20px;
      box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.07);
      z-index: 100;
      display: none;
    }

    .fixed-bottom-buttons.active {
      display: block;
    }

    h1 {
      margin-bottom: 28px;
      font-size: 1.75rem;
      font-weight: 800;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1.3;
      letter-spacing: -0.02em;
    }

    .welcome-icon {
      font-size: 4rem;
      margin-bottom: 24px;
      display: inline-block;
      animation: float 3s ease-in-out infinite;
      filter: drop-shadow(0 10px 20px rgba(59, 130, 246, 0.3));
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .welcome-subtitle {
      color: var(--text-secondary);
      margin-bottom: 32px;
      font-size: 1.1rem;
      line-height: 1.6;
      font-weight: 400;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: none;
      border-radius: 12px;
      padding: 16px 32px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      text-decoration: none;
      background: var(--success-gradient);
      color: white;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
      width: 100%;
      max-width: 280px;
      letter-spacing: 0.02em;
      margin: 0 auto;
    }

    .btn-primary {
      background: var(--accent-gradient);
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .btn:active {
      transform: translateY(-1px);
    }

    .nav-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: var(--nav-bg);
      color: var(--text-primary);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 12px 24px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      min-width: 120px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .nav-btn:hover {
      background: var(--nav-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    form { 
      text-align: left; 
    }

    .form-group { 
      margin-bottom: 28px;
      position: relative;
    }

    label { 
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.95rem;
      letter-spacing: 0.01em;
    }

    label .emoji {
      font-size: 1.2rem;
    }

    input[type="text"], 
    input[type="tel"], 
    input[type="file"], 
    select {
      width: 100%;
      padding: 14px 18px;
      font-size: 1rem;
      border: 2px solid var(--input-border);
      border-radius: 12px;
      background: var(--input-bg);
      color: var(--text-primary);
      transition: all 0.3s ease;
      font-weight: 500;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--input-focus);
      background: var(--card-bg);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
      transform: translateY(-2px);
    }

    input[type="file"] {
      padding: 12px;
      cursor: pointer;
      border: 2px dashed var(--input-border);
      background: var(--input-bg);
      position: relative;
      transition: all 0.3s ease;
    }

    input[type="file"]:hover {
      border-color: var(--input-focus);
      background: var(--card-bg);
    }

    input[type="file"]::file-selector-button {
      background: var(--accent-gradient);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      margin-right: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .radio-group {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }

    .radio-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-primary);
      padding: 10px 20px;
      border: 2px solid var(--input-border);
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    .radio-label:hover {
      border-color: var(--accent-primary);
      background: var(--nav-hover);
    }

    input[type="radio"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    input[type="radio"]:checked + .radio-label {
      border-color: var(--accent-primary);
      background: var(--nav-hover);
    }

    #previewContent {
      text-align: left;
      background: var(--input-bg);
      border-radius: 16px;
      padding: 24px;
      margin: 24px 0;
      border: 1px solid var(--input-border);
    }

    #previewContent .preview-item { 
      margin-bottom: 16px;
      padding: 16px;
      background: var(--card-bg);
      border-radius: 12px;
      border-left: 4px solid var(--input-focus);
      transition: all 0.3s ease;
    }

    #previewContent .preview-item:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-md);
    }

    #previewContent strong {
      color: var(--accent-primary);
      display: block;
      margin-bottom: 6px;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    #previewContent img {
      display: block;
      max-width: 120px;
      height: 120px;
      object-fit: cover;
      margin-top: 12px;
      border-radius: 12px;
      box-shadow: var(--shadow-md);
      transition: transform 0.3s ease;
    }

    #previewContent img:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg);
    }

    .form-progress {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--progress-bg);
      overflow: hidden;
    }

    .form-progress::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: var(--accent-gradient);
      transition: width 0.5s ease;
      width: 0%;
      box-shadow: 0 0 10px var(--glow);
    }

    #step1 .form-progress::before { width: 25%; }
    #step2 .form-progress::before { width: 50%; }
    #step3 .form-progress::before { width: 75%; }
    #step4 .form-progress::before { width: 100%; }

    .button-group {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 28px;
    }

    .address-input-container {
      position: relative;
    }

    .address-input {
      width: 100%;
      padding-right: 50px;
    }

    .map-picker-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--accent-gradient);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .map-picker-btn:hover {
      transform: translateY(-50%) scale(1.1);
    }

    #map {
      width: 100%;
      height: 300px;
      border-radius: 12px;
      margin-top: 15px;
      display: none;
      box-shadow: var(--shadow-lg);
    }

    .offerta-container {
      max-height: 400px;
      overflow-y: auto;
      padding: 20px;
      background: var(--input-bg);
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid var(--input-border);
    }

    .offerta-container h2 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      color: var(--accent-primary);
    }

    .offerta-container p {
      margin-bottom: 12px;
      line-height: 1.6;
      color: var(--text-secondary);
    }

    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 20px 0;
      padding: 15px;
      background: var(--input-bg);
      border-radius: 10px;
      cursor: pointer;
    }

    .checkbox-container input[type="checkbox"] {
      width: 24px;
      height: 24px;
      cursor: pointer;
    }

    .checkbox-container label {
      margin: 0;
      cursor: pointer;
      font-weight: 500;
    }

    /* Mobile Optimizations */
    @media (max-width: 480px) {
      .content-wrapper {
        padding: 12px;
        padding-bottom: 60px;
      }

      .lang-switch {
        top: 12px;
        right: 12px;
      }

      .lang-switch button {
        padding: 6px 14px;
        font-size: 0.8rem;
      }

      .page {
        padding: 24px 20px;
        border-radius: 20px;
        max-width: 100%;
      }

      h1 {
        font-size: 1.5rem;
        margin-bottom: 20px;
      }

      .welcome-icon {
        font-size: 3rem;
        margin-bottom: 20px;
      }

      .welcome-subtitle {
        font-size: 1rem;
        margin-bottom: 24px;
      }

      .btn {
        width: 100%;
        max-width: none;
        padding: 16px 24px;
        font-size: 1.05rem;
      }

      .nav-btn {
        padding: 12px 20px;
        width: 100%;
      }

      .form-group {
        margin-bottom: 20px;
      }

      input[type="text"],
      input[type="tel"],
      input[type="file"],
      select {
        padding: 14px 16px;
        font-size: 16px; /* Prevents zoom on iOS */
      }

      .radio-group {
        flex-direction: column;
      }

      #previewContent {
        padding: 20px;
        margin: 20px 0;
      }

      #previewContent .preview-item {
        padding: 14px;
        margin-bottom: 12px;
      }

      #previewContent img {
        max-width: 100px;
        height: 100px;
      }

      .button-group {
        flex-direction: column;
        gap: 10px;
      }
    }

    /* Loading state */
    .loading {
      pointer-events: none;
      opacity: 0.6;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 40px;
      height: 40px;
      margin: -20px 0 0 -20px;
      border: 3px solid var(--input-border);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Decorative elements */
    .decoration {
      position: fixed;
      pointer-events: none;
      z-index: -1;
    }

    .decoration-1 {
      top: 10%;
      right: 5%;
      width: 200px;
      height: 200px;
      background: var(--accent-gradient);
      opacity: 0.05;
      border-radius: 50%;
      filter: blur(60px);
      animation: float-decoration 20s ease-in-out infinite;
    }

    .decoration-2 {
      bottom: 10%;
      left: 5%;
      width: 300px;
      height: 300px;
      background: var(--success-gradient);
      opacity: 0.05;
      border-radius: 50%;
      filter: blur(80px);
      animation: float-decoration 25s ease-in-out infinite reverse;
    }

    @keyframes float-decoration {
      0%, 100% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(30px, -30px) scale(1.1); }
      66% { transform: translate(-30px, 30px) scale(0.9); }
    }

    .suggestions-container {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border: 1px solid var(--input-border);
      border-radius: 8px;
      margin-top: 5px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      box-shadow: var(--shadow-lg);
    }

    .suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid var(--input-border);
    }

    .suggestion-item:hover {
      background: var(--nav-hover);
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    /* User location marker styles */
    .user-location-marker {
      position: absolute;
      width: 20px;
      height: 20px;
      background: #3b82f6;
      border: 3px solid white;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transform: translate(-50%, -50%);
    }

    .user-location-marker::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 40px;
      height: 40px;
      background: rgba(59, 130, 246, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        transform: translate(-50%, -50%) scale(0.5);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) scale(2);
        opacity: 0;
      }
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://api-maps.yandex.ru/2.1/?apikey=8a3e4da0-9ef2-4176-9203-e7014c1dba6f&lang=ru_RU" type="text/javascript"></script>
</head>
<body>
  <div class="decoration decoration-1"></div>
  <div class="decoration decoration-2"></div>

  <div class="lang-switch">
    <button onclick="setLang('ru')" id="lang-ru" class="active">RU</button>
    <button onclick="setLang('kz')" id="lang-kz">KZ</button>
  </div>

  <div class="content-wrapper">
    <!-- Step 0: Check Registration -->
    <div id="step0" class="page active">
      <div class="welcome-icon">üöö</div>
      <h1 data-ru="–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏..." data-kz="–¢—ñ—Ä–∫–µ–ª—É–¥—ñ —Ç–µ–∫—Å–µ—Ä—É...">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏...</h1>
      <p class="welcome-subtitle" data-ru="–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ" data-kz="–ö“Ø—Ç–µ —Ç“±—Ä—ã“£—ã–∑">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
    </div>

    <!-- Step 1: Offerta -->
    <div id="step1" class="page">
      <div class="form-progress"></div>
      <h1 data-ru="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ" data-kz="–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã –∫–µ–ª—ñ—Å—ñ–º—ñ">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ</h1>
      <div class="offerta-container">
        <h2 data-ru="–û—Ñ–µ—Ä—Ç–∞ –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π" data-kz="–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ–ª–µ—Ä–≥–µ –∞—Ä–Ω–∞–ª“ì–∞–Ω –æ—Ñ–µ—Ä—Ç–∞">–û—Ñ–µ—Ä—Ç–∞ –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π</h2>
        <p data-ru="–ù–∞—Å—Ç–æ—è—â–µ–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ (–¥–∞–ª–µ–µ ‚Äî –°–æ–≥–ª–∞—à–µ–Ω–∏–µ) —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç –æ—Ç–Ω–æ—à–µ–Ω–∏—è –º–µ–∂–¥—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π —Å–µ—Ä–≤–∏—Å–∞ –ª–æ–≥–∏—Å—Ç–∏–∫–∏ (–¥–∞–ª–µ–µ ‚Äî –°–µ—Ä–≤–∏—Å) –∏ –≤–æ–¥–∏—Ç–µ–ª–µ–º (–¥–∞–ª–µ–µ ‚Äî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)."
           data-kz="–û—Å—ã –ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã –∫–µ–ª—ñ—Å—ñ–º—ñ (–±“±–¥–∞–Ω ”ô—Ä—ñ ‚Äî –ö–µ–ª—ñ—Å—ñ–º) –ª–æ–≥–∏—Å—Ç–∏–∫–∞ “õ—ã–∑–º–µ—Ç—ñ–Ω—ñ“£ ”ô–∫—ñ–º—à—ñ–ª—ñ–≥—ñ (–±“±–¥–∞–Ω ”ô—Ä—ñ ‚Äî “ö—ã–∑–º–µ—Ç) –º–µ–Ω –∂“Ø—Ä–≥—ñ–∑—É—à—ñ (–±“±–¥–∞–Ω ”ô—Ä—ñ ‚Äî –ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã) –∞—Ä–∞—Å—ã–Ω–¥–∞“ì—ã “õ–∞—Ç—ã–Ω–∞—Å—Ç–∞—Ä–¥—ã —Ä–µ—Ç—Ç–µ–π–¥—ñ.">
          –ù–∞—Å—Ç–æ—è—â–µ–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ (–¥–∞–ª–µ–µ ‚Äî –°–æ–≥–ª–∞—à–µ–Ω–∏–µ) —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç –æ—Ç–Ω–æ—à–µ–Ω–∏—è –º–µ–∂–¥—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π —Å–µ—Ä–≤–∏—Å–∞ –ª–æ–≥–∏—Å—Ç–∏–∫–∏ (–¥–∞–ª–µ–µ ‚Äî –°–µ—Ä–≤–∏—Å) –∏ –≤–æ–¥–∏—Ç–µ–ª–µ–º (–¥–∞–ª–µ–µ ‚Äî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å).
        </p>
        <p data-ru="1. –ü—Ä–µ–¥–º–µ—Ç —Å–æ–≥–ª–∞—à–µ–Ω–∏—è. –°–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–∫–∏."
           data-kz="1. –ö–µ–ª—ñ—Å—ñ–º–Ω—ñ“£ –º”ô–Ω—ñ. “ö—ã–∑–º–µ—Ç –∂“Ø–∫ —Ç–∞—Å—ã–º–∞–ª–¥–∞—É —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä—ã–Ω —ñ–∑–¥–µ—É –∂”ô–Ω–µ –æ—Ä—ã–Ω–¥–∞—É “Ø—à—ñ–Ω –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ “±—Å—ã–Ω–∞–¥—ã.">
          1. –ü—Ä–µ–¥–º–µ—Ç —Å–æ–≥–ª–∞—à–µ–Ω–∏—è. –°–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–∫–∏.
        </p>
        <p data-ru="2. –ü—Ä–∞–≤–∞ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –≤–æ–¥–∏—Ç–µ–ª—è. –í–æ–¥–∏—Ç–µ–ª—å –æ–±—è–∑—É–µ—Ç—Å—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –∏–º–µ—Ç—å –¥–µ–π—Å—Ç–≤—É—é—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ –ø—Ä–∞–≤–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–º —Å—Ä–µ–¥—Å—Ç–≤–æ–º."
           data-kz="2. –ñ“Ø—Ä–≥—ñ–∑—É—à—ñ–Ω—ñ“£ “õ“±“õ—ã“õ—Ç–∞—Ä—ã –º–µ–Ω –º—ñ–Ω–¥–µ—Ç—Ç–µ—Ä—ñ. –ñ“Ø—Ä–≥—ñ–∑—É—à—ñ —Ç—ñ—Ä–∫–µ–ª—É –∫–µ–∑—ñ–Ω–¥–µ –¥“±—Ä—ã—Å –∞“õ–ø–∞—Ä–∞—Ç –±–µ—Ä—É–≥–µ, –∫”©–ª—ñ–∫ “õ“±—Ä–∞–ª—ã–Ω –±–∞—Å“õ–∞—Ä—É “õ“±“õ—ã“ì—ã–Ω–∞ “õ–æ–ª–¥–∞–Ω—ã—Å—Ç–∞“ì—ã “õ“±–∂–∞—Ç—Ç–∞—Ä—ã–Ω—ã“£ –±–æ–ª—É—ã–Ω–∞ –º—ñ–Ω–¥–µ—Ç—Ç–µ–Ω–µ–¥—ñ.">
          2. –ü—Ä–∞–≤–∞ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –≤–æ–¥–∏—Ç–µ–ª—è. –í–æ–¥–∏—Ç–µ–ª—å –æ–±—è–∑—É–µ—Ç—Å—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –∏–º–µ—Ç—å –¥–µ–π—Å—Ç–≤—É—é—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ –ø—Ä–∞–≤–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–º —Å—Ä–µ–¥—Å—Ç–≤–æ–º.
        </p>
        <p data-ru="3. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å. –í–æ–¥–∏—Ç–µ–ª—å –Ω–µ—Å–µ—Ç –ø–æ–ª–Ω—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å –≥—Ä—É–∑–∞ –∏ —Å–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–æ—Å—Ç–∞–≤–∫—É."
           data-kz="3. –ñ–∞—É–∞–ø–∫–µ—Ä—à—ñ–ª—ñ–∫. –ñ“Ø—Ä–≥—ñ–∑—É—à—ñ –∂“Ø–∫—Ç—ñ“£ —Å–∞“õ—Ç–∞–ª—É—ã –∂”ô–Ω–µ —É–∞“õ—Ç—ã–ª—ã –∂–µ—Ç–∫—ñ–∑—ñ–ª—É—ñ “Ø—à—ñ–Ω —Ç–æ–ª—ã“õ –∂–∞—É–∞–ø–∫–µ—Ä—à—ñ–ª—ñ–∫ –∞–ª–∞–¥—ã.">
          3. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å. –í–æ–¥–∏—Ç–µ–ª—å –Ω–µ—Å–µ—Ç –ø–æ–ª–Ω—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å –≥—Ä—É–∑–∞ –∏ —Å–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–æ—Å—Ç–∞–≤–∫—É.
        </p>
        <p data-ru="4. –ö–æ–º–∏—Å—Å–∏—è —Å–µ—Ä–≤–∏—Å–∞. –°–µ—Ä–≤–∏—Å –≤–∑–∏–º–∞–µ—Ç –∫–æ–º–∏—Å—Å–∏—é –≤ —Ä–∞–∑–º–µ—Ä–µ 10% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞."
           data-kz="4. “ö—ã–∑–º–µ—Ç –∫–æ–º–∏—Å—Å–∏—è—Å—ã. “ö—ã–∑–º–µ—Ç ”ô—Ä–±—ñ—Ä –æ—Ä—ã–Ω–¥–∞–ª“ì–∞–Ω —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç—ã“£ “õ“±–Ω—ã–Ω–∞–Ω 10% –º”©–ª—à–µ—Ä—ñ–Ω–¥–µ –∫–æ–º–∏—Å—Å–∏—è –∞–ª–∞–¥—ã.">
          4. –ö–æ–º–∏—Å—Å–∏—è —Å–µ—Ä–≤–∏—Å–∞. –°–µ—Ä–≤–∏—Å –≤–∑–∏–º–∞–µ—Ç –∫–æ–º–∏—Å—Å–∏—é –≤ —Ä–∞–∑–º–µ—Ä–µ 10% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞.
        </p>
        <p data-ru="5. –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å. –°–µ—Ä–≤–∏—Å –æ–±—è–∑—É–µ—Ç—Å—è –Ω–µ —Ä–∞–∑–≥–ª–∞—à–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª—è —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º."
           data-kz="5. “ö“±–ø–∏—è–ª—ã–ª—ã“õ. “ö—ã–∑–º–µ—Ç –∂“Ø—Ä–≥—ñ–∑—É—à—ñ–Ω—ñ“£ –∂–µ–∫–µ –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ–Ω “Ø—à—ñ–Ω—à—ñ —Ç“±–ª“ì–∞–ª–∞—Ä“ì–∞ –∂–∞—Ä–∏—è–ª–∞–º–∞—É“ì–∞ –º—ñ–Ω–¥–µ—Ç—Ç–µ–Ω–µ–¥—ñ.">
          5. –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å. –°–µ—Ä–≤–∏—Å –æ–±—è–∑—É–µ—Ç—Å—è –Ω–µ —Ä–∞–∑–≥–ª–∞—à–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª—è —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º.
        </p>
      </div>
      <div class="checkbox-container">
        <input type="checkbox" id="acceptOfferta">
        <label for="acceptOfferta" data-ru="–Ø –ø—Ä–æ—á–∏—Ç–∞–ª –∏ –ø—Ä–∏–Ω–∏–º–∞—é —É—Å–ª–æ–≤–∏—è —Å–æ–≥–ª–∞—à–µ–Ω–∏—è" data-kz="–ú–µ–Ω –∫–µ–ª—ñ—Å—ñ–º —à–∞—Ä—Ç—Ç–∞—Ä—ã–Ω –æ“õ—ã–¥—ã–º –∂”ô–Ω–µ “õ–∞–±—ã–ª–¥–∞–π–º—ã–Ω">–Ø –ø—Ä–æ—á–∏—Ç–∞–ª –∏ –ø—Ä–∏–Ω–∏–º–∞—é —É—Å–ª–æ–≤–∏—è —Å–æ–≥–ª–∞—à–µ–Ω–∏—è</label>
      </div>
      <button id="continueToForm" class="btn btn-primary" disabled>
        <span>‚úÖ</span>
        <span data-ru="–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" data-kz="–ñ–∞–ª“ì–∞—Å—Ç—ã—Ä—É">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</span>
      </button>
    </div>

    <!-- Step 2: Registration Form -->
    <div id="step2" class="page">
      <div class="form-progress"></div>
      <h1 data-ru="–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–æ–¥–∏—Ç–µ–ª—è" data-kz="–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ–Ω—ñ —Ç—ñ—Ä–∫–µ—É">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–æ–¥–∏—Ç–µ–ª—è</h1>
      <form id="driverForm" enctype="multipart/form-data">
        <div class="form-group">
          <label for="profile_photo">
            <span class="emoji">üì∏</span>
            <span data-ru="–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è" data-kz="–ü—Ä–æ—Ñ–∏–ª—å —Ñ–æ—Ç–æ—Å—ã">–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è</span>
          </label>
          <input type="file" id="profile_photo" name="profile_photo" accept="image/*" required>
        </div>
        <div class="form-group">
          <label for="full_name">
            <span class="emoji">üë§</span>
            <span data-ru="–§–ò–û" data-kz="–ê—Ç—ã-–∂”©–Ω—ñ">–§–ò–û</span>
          </label>
          <input type="text" id="full_name" name="full_name" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" required>
        </div>
        <div class="form-group">
          <label for="contact">
            <span class="emoji">üì±</span>
            <span data-ru="–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä" data-kz="–ë–∞–π–ª–∞–Ω—ã—Å –Ω”©–º—ñ—Ä—ñ">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä</span>
          </label>
          <input type="tel" id="contact" name="contact" placeholder="+7 (___) ___-__-__" required>
        </div>
        <div class="form-group">
          <label for="driver_license">
            <span class="emoji">üìã</span>
            <span data-ru="–í–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ" data-kz="–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ –∫—É”ô–ª—ñ–≥—ñ">–í–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ</span>
          </label>
          <input type="file" id="driver_license" name="driver_license" accept=".pdf,.jpg,.png" required>
        </div>
        <div class="form-group">
          <label for="truck_photo">
            <span class="emoji">üöõ</span>
            <span data-ru="–§–æ—Ç–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞" data-kz="–ö”©–ª—ñ–∫ —Ñ–æ—Ç–æ—Å—ã">–§–æ—Ç–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</span>
          </label>
          <input type="file" id="truck_photo" name="truck_photo" accept="image/*" required>
        </div>
        <div class="form-group">
          <label>
            <span class="emoji">‚ößÔ∏è</span>
            <span data-ru="–ü–æ–ª" data-kz="–ñ—ã–Ω—ã—Å—ã">–ü–æ–ª</span>
          </label>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="gender" value="male" required>
              <span data-ru="–ú—É–∂—Å–∫–æ–π" data-kz="–ï—Ä">–ú—É–∂—Å–∫–æ–π</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="gender" value="female" required>
              <span data-ru="–ñ–µ–Ω—Å–∫–∏–π" data-kz="”ò–π–µ–ª">–ñ–µ–Ω—Å–∫–∏–π</span>
            </label>
          </div>
        </div>
        <div class="form-group">
          <label for="start_city">
            <span class="emoji">üìç</span>
            <span data-ru="–ì–æ—Ä–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è" data-kz="–ñ”©–Ω–µ–ª—É “õ–∞–ª–∞—Å—ã">–ì–æ—Ä–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è</span>
          </label>
          <div class="address-input-container">
            <input type="text" id="start_city" name="start_city" class="address-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ" required>
            <button type="button" class="map-picker-btn" onclick="toggleMap('start_city')">üìç</button>
          </div>
          <div id="map" style="display: none;"></div>
          <div id="start_city_suggestions" class="suggestions-container" style="display: none;"></div>
        </div>
        <input type="hidden" name="telegram_id" id="telegram_id">
        <input type="hidden" name="start_lat" id="start_lat">
        <input type="hidden" name="start_lon" id="start_lon">
      </form>
    </div>

    <!-- Step 3: Preview -->
    <div id="step3" class="page">
      <div class="form-progress"></div>
      <h1 data-ru="–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ" data-kz="–î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ —Ç–µ–∫—Å–µ—Ä—ñ“£—ñ–∑">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ</h1>
      <div id="previewContent"></div>
    </div>

    <!-- Step 4: Success -->
    <div id="step4" class="page">
      <div class="form-progress"></div>
      <div class="welcome-icon">‚úÖ</div>
      <h1 data-ru="–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!" data-kz="–¢—ñ—Ä–∫–µ–ª—É –∞—è“õ—Ç–∞–ª–¥—ã!">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h1>
      <p class="welcome-subtitle" data-ru="–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞–∫–∞–∑—ã" data-kz="–ï–Ω–¥—ñ —Å—ñ–∑ —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä–¥—ã “õ–∞–±—ã–ª–¥–∞–π –∞–ª–∞—Å—ã–∑">–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞–∫–∞–∑—ã</p>
      <button id="goToRequests" class="btn">
        <span>üìã</span>
        <span data-ru="–ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–∫–∞–∑–∞–º" data-kz="–¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä“ì–∞ ”©—Ç—É">–ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–∫–∞–∑–∞–º</span>
      </button>
    </div>
  </div>

  <div class="fixed-bottom-buttons" id="fixedButtons">
    <div class="button-group">
      <button type="button" id="backBtn" class="nav-btn" style="display: none;">‚Üê <span data-ru="–ù–∞–∑–∞–¥" data-kz="–ê—Ä—Ç“õ–∞">–ù–∞–∑–∞–¥</span></button>
    </div>
  </div>

  <script>
    // Set Telegram viewport height
    function updateViewportHeight() {
      const vh = Telegram.WebApp.viewportHeight;
      document.documentElement.style.setProperty('--tg-viewport-height', `${vh}px`);
    }

    // Update on init and resize
    updateViewportHeight();
    Telegram.WebApp.onEvent('viewportChanged', updateViewportHeight);

    // Language management
    let currentLang = 'ru';
    const translations = {
      ru: {
        checking: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏...',
        pleaseWait: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ',
        profilePhoto: '–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è',
        fullName: '–§–ò–û',
        contactNumber: '–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä',
        driverLicense: '–í–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ',
        truckPhoto: '–§–æ—Ç–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞',
        gender: '–ü–æ–ª',
        male: '–ú—É–∂—Å–∫–æ–π',
        female: '–ñ–µ–Ω—Å–∫–∏–π',
        startCity: '–ì–æ—Ä–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è',
        back: '–ù–∞–∑–∞–¥',
        checkData: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ',
        register: '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è',
        registrationComplete: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!',
        canAcceptOrders: '–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞–∫–∞–∑—ã',
        goToOrders: '–ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–∫–∞–∑–∞–º',
        enterAddress: '–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ',
        searchingAddress: '–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞...',
        addressNotFound: '–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω',
        selectOnMap: '–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ',
        confirm: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å',
        offertaTitle: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ',
        acceptTerms: '–Ø –ø—Ä–æ—á–∏—Ç–∞–ª –∏ –ø—Ä–∏–Ω–∏–º–∞—é —É—Å–ª–æ–≤–∏—è —Å–æ–≥–ª–∞—à–µ–Ω–∏—è',
        continue: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å',
        fillAllFields: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è',
        acceptOfferta: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏–º–∏—Ç–µ —É—Å–ª–æ–≤–∏—è —Å–æ–≥–ª–∞—à–µ–Ω–∏—è',
        followingYou: '–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ',
        locationDenied: '–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –¥–ª—è –ª—É—á—à–µ–π —Ä–∞–±–æ—Ç—ã'
      },
      kz: {
        checking: '–¢—ñ—Ä–∫–µ–ª—É–¥—ñ —Ç–µ–∫—Å–µ—Ä—É...',
        pleaseWait: '–ö“Ø—Ç–µ —Ç“±—Ä—ã“£—ã–∑',
        profilePhoto: '–ü—Ä–æ—Ñ–∏–ª—å —Ñ–æ—Ç–æ—Å—ã',
        fullName: '–ê—Ç—ã-–∂”©–Ω—ñ',
        contactNumber: '–ë–∞–π–ª–∞–Ω—ã—Å –Ω”©–º—ñ—Ä—ñ',
        driverLicense: '–ñ“Ø—Ä–≥—ñ–∑—É—à—ñ –∫—É”ô–ª—ñ–≥—ñ',
        truckPhoto: '–ö”©–ª—ñ–∫ —Ñ–æ—Ç–æ—Å—ã',
        gender: '–ñ—ã–Ω—ã—Å—ã',
        male: '–ï—Ä',
        female: '”ò–π–µ–ª',
        startCity: '–ñ”©–Ω–µ–ª—É “õ–∞–ª–∞—Å—ã',
        back: '–ê—Ä—Ç“õ–∞',
        checkData: '–î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ —Ç–µ–∫—Å–µ—Ä—É',
        register: '–¢—ñ—Ä–∫–µ–ª—É',
        registrationComplete: '–¢—ñ—Ä–∫–µ–ª—É –∞—è“õ—Ç–∞–ª–¥—ã!',
        canAcceptOrders: '–ï–Ω–¥—ñ —Å—ñ–∑ —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä–¥—ã “õ–∞–±—ã–ª–¥–∞–π –∞–ª–∞—Å—ã–∑',
        goToOrders: '–¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä“ì–∞ ”©—Ç—É',
        enterAddress: '–ú–µ–∫–µ–Ω–∂–∞–π–¥—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑ –Ω–µ–º–µ—Å–µ –∫–∞—Ä—Ç–∞–¥–∞–Ω —Ç–∞“£–¥–∞“£—ã–∑',
        searchingAddress: '–ú–µ–∫–µ–Ω–∂–∞–π–¥—ã —ñ–∑–¥–µ—É...',
        addressNotFound: '–ú–µ–∫–µ–Ω–∂–∞–π —Ç–∞–±—ã–ª–º–∞–¥—ã',
        selectOnMap: '–ö–∞—Ä—Ç–∞–¥–∞–Ω –æ—Ä—ã–Ω–¥—ã —Ç–∞“£–¥–∞“£—ã–∑',
        confirm: '–†–∞—Å—Ç–∞—É',
        offertaTitle: '–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã –∫–µ–ª—ñ—Å—ñ–º—ñ',
        acceptTerms: '–ú–µ–Ω –∫–µ–ª—ñ—Å—ñ–º —à–∞—Ä—Ç—Ç–∞—Ä—ã–Ω –æ“õ—ã–¥—ã–º –∂”ô–Ω–µ “õ–∞–±—ã–ª–¥–∞–π–º—ã–Ω',
        continue: '–ñ–∞–ª“ì–∞—Å—Ç—ã—Ä—É',
        fillAllFields: '–ë–∞—Ä–ª—ã“õ ”©—Ä—ñ—Å—Ç–µ—Ä–¥—ñ —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑',
        acceptOfferta: '–ö–µ–ª—ñ—Å—ñ–º —à–∞—Ä—Ç—Ç–∞—Ä—ã–Ω “õ–∞–±—ã–ª–¥–∞“£—ã–∑',
        followingYou: '–°—ñ–∑–¥—ñ“£ –æ—Ä–Ω–∞–ª–∞—Å“õ–∞–Ω –∂–µ—Ä—ñ“£—ñ–∑–¥—ñ –±–∞“õ—ã–ª–∞–ø –æ—Ç—ã—Ä–º—ã–∑',
        locationDenied: '–ñ–∞“õ—Å—ã –∂“±–º—ã—Å —ñ—Å—Ç–µ—É “Ø—à—ñ–Ω –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è“ì–∞ —Ä“±“õ—Å–∞—Ç –±–µ—Ä—ñ“£—ñ–∑'
      }
    };

    function setLang(lang) {
      currentLang = lang;
      document.querySelectorAll('.lang-switch button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById('lang-' + lang).classList.add('active');
      
      // Update all elements with data attributes
      document.querySelectorAll('[data-ru]').forEach(el => {
        el.textContent = el.getAttribute('data-' + lang) || el.textContent;
      });
      
      // Update placeholders
      document.getElementById('start_city').placeholder = translations[lang].enterAddress;
      
      // Update main button text based on current step
      updateMainButtonText();
    }

    // Theme management
    function detectSystemTheme() {
      const hour = new Date().getHours();
      return (hour >= 20 || hour < 6) ? 'dark' : 'light';
    }

    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
    }

    let currentTheme = detectSystemTheme();
    applyTheme(currentTheme);

    setInterval(() => {
      const newTheme = detectSystemTheme();
      if (newTheme !== currentTheme) {
        currentTheme = newTheme;
        applyTheme(currentTheme);
      }
    }, 60000);

    // Telegram WebApp initialization
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
    
    const user = Telegram.WebApp.initDataUnsafe?.user;
    if (user) {
      document.getElementById('telegram_id').value = user.id;
    }

    // Theme from Telegram
    if (Telegram.WebApp.colorScheme) {
      currentTheme = Telegram.WebApp.colorScheme;
      applyTheme(currentTheme);
    }

    Telegram.WebApp.onEvent('themeChanged', function() {
      if (Telegram.WebApp.colorScheme) {
        currentTheme = Telegram.WebApp.colorScheme;
        applyTheme(currentTheme);
      }
    });

    // Yandex Maps with real-time tracking
    let myMap;
    let currentPlacemark;
    let userLocationPlacemark;
    let currentField = '';
    let watchId;

    ymaps.ready(initMap);

    function initMap() {
      // Request geolocation with high accuracy
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            initMapWithPosition([position.coords.latitude, position.coords.longitude]);
            startLocationTracking();
          },
          (error) => {
            console.error('Geolocation error:', error);
            initMapWithPosition([43.238949, 76.889709]); // Default to Almaty
            Telegram.WebApp.showAlert(translations[currentLang].locationDenied);
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          }
        );
      } else {
        initMapWithPosition([43.238949, 76.889709]); // Default to Almaty
      }
    }

    function initMapWithPosition(center) {
      myMap = new ymaps.Map("map", {
        center: center,
        zoom: 14,
        controls: [] // Remove all default controls
      });

      // Add only zoom control
      myMap.controls.add('zoomControl', {
        position: {
          right: 10,
          top: 10
        }
      });

      // Customize map behavior
      myMap.behaviors.disable(['scrollZoom']); // Disable scroll zoom
      
      // Add user location marker
      addUserLocationMarker(center);

      // Click handler for selecting location
      myMap.events.add('click', function (e) {
        const coords = e.get('coords');
        setPlacemark(coords);
        getAddress(coords);
      });
    }

    function addUserLocationMarker(coords) {
      userLocationPlacemark = new ymaps.Placemark(coords, {
        hintContent: translations[currentLang].followingYou
      }, {
        iconLayout: 'default#imageWithContent',
        iconImageHref: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMCIgaGVpZ2h0PSIzMCIgdmlld0JveD0iMCAwIDMwIDMwIj4KICA8Y2lyY2xlIGN4PSIxNSIgY3k9IjE1IiByPSIxMCIgZmlsbD0iIzNiODJmNiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIzIi8+CiAgPGNpcmNsZSBjeD0iMTUiIGN5PSIxNSIgcj0iNCIgZmlsbD0id2hpdGUiLz4KPC9zdmc+',
        iconImageSize: [30, 30],
        iconImageOffset: [-15, -15],
        iconContentLayout: ymaps.templateLayoutFactory.createClass(
          '<div class="user-location-marker"></div>'
        )
      });

      myMap.geoObjects.add(userLocationPlacemark);
    }

    function startLocationTracking() {
      if (navigator.geolocation) {
        watchId = navigator.geolocation.watchPosition(
          (position) => {
            const newCoords = [position.coords.latitude, position.coords.longitude];
            if (userLocationPlacemark) {
              userLocationPlacemark.geometry.setCoordinates(newCoords);
              
              // Smoothly pan to new location if user moved significantly
              const currentCenter = myMap.getCenter();
              const distance = ymaps.coordSystem.geo.getDistance(currentCenter, newCoords);
              
              if (distance > 100) { // If moved more than 100 meters
                myMap.panTo(newCoords, {
                  duration: 500,
                  checkZoomRange: true
                });
              }
            }
          },
          (error) => {
            console.error('Location tracking error:', error);
          },
          {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
          }
        );
      }
    }

    function setPlacemark(coords) {
      if (currentPlacemark) {
        myMap.geoObjects.remove(currentPlacemark);
      }

      currentPlacemark = new ymaps.Placemark(coords, {}, {
        preset: 'islands#blueIcon',
        draggable: true
      });

      myMap.geoObjects.add(currentPlacemark);
      myMap.setCenter(coords, 15);

      currentPlacemark.events.add('dragend', function () {
        const newCoords = currentPlacemark.geometry.getCoordinates();
        getAddress(newCoords);
      });

      // Save coordinates
      if (currentField === 'start_city') {
        document.getElementById('start_lat').value = coords[0];
        document.getElementById('start_lon').value = coords[1];
      }
    }

    function getAddress(coords) {
      ymaps.geocode(coords, {
        kind: 'locality',
        results: 1
      }).then(function (res) {
        const firstGeoObject = res.geoObjects.get(0);
        const address = firstGeoObject.getAddressLine();
        
        if (currentField === 'start_city') {
          document.getElementById('start_city').value = address;
        }
      });
    }

    function toggleMap(field) {
      currentField = field;
      const mapDiv = document.getElementById('map');
      
      if (mapDiv.style.display === 'none') {
        mapDiv.style.display = 'block';
        setTimeout(() => {
          myMap.container.fitToViewport();
        }, 100);
      } else {
        mapDiv.style.display = 'none';
      }
    }

    // Address suggestions with Kazakhstan priority
    let suggestTimeout;
    document.getElementById('start_city').addEventListener('input', function(e) {
      clearTimeout(suggestTimeout);
      const query = e.target.value;
      
      if (query.length < 3) {
        document.getElementById('start_city_suggestions').style.display = 'none';
        return;
      }
      
      suggestTimeout = setTimeout(() => {
        // Search with Kazakhstan bounds priority
        const searchPromise = ymaps.suggest(query, {
          boundedBy: [[41.15, 46.99], [55.44, 87.31]], // Kazakhstan bounds
          strictBounds: false,
          results: 10
        });
        
        searchPromise.then(function (items) {
          // Filter and prioritize Kazakhstan results
          const kazakhstanItems = items.filter(item => 
            item.displayName.includes('–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω') || 
            item.displayName.includes('Kazakhstan') ||
            item.value.includes('–ê–ª–º–∞—Ç—ã') ||
            item.value.includes('–ê—Å—Ç–∞–Ω–∞') ||
            item.value.includes('–ù—É—Ä-–°—É–ª—Ç–∞–Ω')
          );
          
          const otherItems = items.filter(item => 
            !kazakhstanItems.includes(item)
          );
          
          const sortedItems = [...kazakhstanItems, ...otherItems];
          displaySuggestions('start_city', sortedItems.slice(0, 5));
        });
      }, 300);
    });

    function displaySuggestions(field, items) {
      const container = document.getElementById(field + '_suggestions');
      container.innerHTML = '';
      
      if (items.length === 0) {
        container.style.display = 'none';
        return;
      }
      
      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'suggestion-item';
        div.textContent = item.displayName;
        div.onclick = function() {
          document.getElementById(field).value = item.value;
          container.style.display = 'none';
          
          // Geocode to get coordinates
          ymaps.geocode(item.value, {
            results: 1
          }).then(function(res) {
            const firstGeoObject = res.geoObjects.get(0);
            const coords = firstGeoObject.geometry.getCoordinates();
            setPlacemark(coords);
            
            if (field === 'start_city') {
              document.getElementById('start_lat').value = coords[0];
              document.getElementById('start_lon').value = coords[1];
            }
          });
        };
        container.appendChild(div);
      });
      
      container.style.display = 'block';
    }

    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.classList.contains('address-input')) {
        document.querySelectorAll('.suggestions-container').forEach(container => {
          container.style.display = 'none';
        });
      }
    });

    // Step navigation
    let currentStep = 0;
    
    function show(step) {
      currentStep = step;
      [0,1,2,3,4].forEach(i => {
        const el = document.getElementById('step'+i);
        el.classList.toggle('active', i===step);
      });
      
      // Update fixed buttons
      const fixedButtons = document.getElementById('fixedButtons');
      const backBtn = document.getElementById('backBtn');
      
      if (step === 2 || step === 3) {
        fixedButtons.classList.add('active');
        backBtn.style.display = 'inline-flex';
      } else {
        fixedButtons.classList.remove('active');
      }
      
      Telegram.WebApp.MainButton.hide();
      updateMainButtonText();
    }

    function updateMainButtonText() {
      if (currentStep === 2) {
        Telegram.WebApp.MainButton.setText('üìã ' + translations[currentLang].checkData);
        Telegram.WebApp.MainButton.show();
        Telegram.WebApp.MainButton.color = '#10b981';
      } else if (currentStep === 3) {
        Telegram.WebApp.MainButton.setText('‚úÖ ' + translations[currentLang].register);
        Telegram.WebApp.MainButton.show();
        Telegram.WebApp.MainButton.color = '#3b82f6';
      }
    }

    // Check if driver exists
    async function checkDriverExists() {
      try {
        const response = await fetch('/api/driver/check', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            telegram_id: document.getElementById('telegram_id').value
          })
        });
        
        const data = await response.json();
        
        if (data.exists) {
          // Driver already registered, redirect to requests
          window.location.href = '/driver-request';
        } else {
          // Show offerta
          show(1);
        }
      } catch (error) {
        console.error('Error checking driver:', error);
        // Show offerta on error
        show(1);
      }
    }

    // Check on load
    setTimeout(checkDriverExists, 1000);

    // Offerta acceptance
    document.getElementById('acceptOfferta').addEventListener('change', function() {
      document.getElementById('continueToForm').disabled = !this.checked;
    });

    document.getElementById('continueToForm').onclick = () => {
      if (document.getElementById('acceptOfferta').checked) {
        show(2);
      } else {
        Telegram.WebApp.showAlert(translations[currentLang].acceptOfferta);
      }
    };

    // Navigation handlers
    document.getElementById('backBtn').onclick = () => {
      if (currentStep === 2) show(1);
      else if (currentStep === 3) show(2);
    };
    
    document.getElementById('goToRequests').onclick = () => {
      window.location.href = '/driver-request';
    };

    // Form preview
    function buildPreview() {
      const f = document.getElementById('driverForm');
      if (!f.checkValidity()) { 
        f.reportValidity(); 
        return false; 
      }
      
      const data = new FormData(f);
      let html = '';
      
      // Profile photo
      const profilePhoto = data.get('profile_photo');
      if (profilePhoto && profilePhoto.name) {
        const url = URL.createObjectURL(profilePhoto);
        html += `<div class="preview-item">
          <strong>${translations[currentLang].profilePhoto}</strong>
          <img src="${url}" alt="profile">
        </div>`;
      }
      
      // Name
      html += `<div class="preview-item">
        <strong>${translations[currentLang].fullName}</strong>
        ${data.get('full_name')}
      </div>`;
      
      // Contact
      html += `<div class="preview-item">
        <strong>${translations[currentLang].contactNumber}</strong>
        ${data.get('contact')}
      </div>`;
      
      // Gender
      const gender = data.get('gender') === 'male' ? translations[currentLang].male : translations[currentLang].female;
      html += `<div class="preview-item">
        <strong>${translations[currentLang].gender}</strong>
        ${gender}
      </div>`;
      
      // Start city
      html += `<div class="preview-item">
        <strong>${translations[currentLang].startCity}</strong>
        ${data.get('start_city')}
      </div>`;
      
      // Truck photo
      const truckPhoto = data.get('truck_photo');
      if (truckPhoto && truckPhoto.name) {
        const url = URL.createObjectURL(truckPhoto);
        html += `<div class="preview-item">
          <strong>${translations[currentLang].truckPhoto}</strong>
          <img src="${url}" alt="truck">
        </div>`;
      }
      
      document.getElementById('previewContent').innerHTML = html;
      return true;
    }

    // Main button handler
    Telegram.WebApp.onEvent('mainButtonClicked', () => {
      if (currentStep === 2) {
        if (buildPreview()) {
          show(3);
        }
      } else if (currentStep === 3) {
        submitRegistration();
      }
    });

    // Submit registration
    async function submitRegistration() {
      document.getElementById('step3').classList.add('loading');
      Telegram.WebApp.MainButton.showProgress();
      
      const fd = new FormData(document.getElementById('driverForm'));
      
      try {
        const response = await fetch('/api/driver/register', {
          method: 'POST',
          mode: 'cors',
          body: fd
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        Telegram.WebApp.MainButton.hideProgress();
        document.getElementById('step3').classList.remove('loading');
        
        if (result.success) {
          show(4);
        } else {
          Telegram.WebApp.showAlert(result.message || 'Registration failed');
        }
      } catch (error) {
        console.error('Error:', error);
        Telegram.WebApp.MainButton.hideProgress();
        document.getElementById('step3').classList.remove('loading');
        Telegram.WebApp.showAlert('Error: ' + error.message);
      }
    }

    // Phone formatting
    document.getElementById('contact').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      let formattedValue = '';
      
      if (value.length > 0) {
        formattedValue = '+7';
        if (value.length > 1) {
          formattedValue += ' (' + value.substring(1, 4);
          if (value.length > 4) {
            formattedValue += ') ' + value.substring(4, 7);
            if (value.length > 7) {
              formattedValue += '-' + value.substring(7, 9);
              if (value.length > 9) {
                formattedValue += '-' + value.substring(9, 11);
              }
            }
          } else if (value.length > 1) {
            formattedValue += ')';
          }
        }
      }
      
      e.target.value = formattedValue;
    });

    // File input visual feedback
    document.querySelectorAll('input[type="file"]').forEach(input => {
      input.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
          e.target.style.borderColor = 'var(--accent-primary)';
          e.target.style.background = 'var(--card-bg)';
          
          const parent = e.target.parentElement;
          parent.style.transform = 'scale(0.98)';
          setTimeout(() => {
            parent.style.transform = 'scale(1)';
          }, 200);
        }
      });
    });

    // Clean up location tracking on page unload
    window.addEventListener('beforeunload', () => {
      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
      }
    });
  </script>
</body>
</html>